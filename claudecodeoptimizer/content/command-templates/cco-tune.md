---
name: cco-tune
description: Project-specific AI tuning and configuration
allowed-tools: Read(*), Write(*), Edit(*), Grep(*), Glob(*), Bash(git:*), Bash(cco-setup:*), Bash(sed:*), Bash(find:*), Bash(wc:*), Task(*), TodoWrite
---

# /cco-tune

**Project tuning** - Detection, configuration, removal, and export for the current project.

**Rules:** User Input | Question Formatting | Option Ordering | Pagination | Task Tracking

## Scope

| Tool | Location | What It Does |
|------|----------|--------------|
| `cco-setup` | `~/.claude/` (global) | Commands, Agents, Rules to `rules/cco/` |
| `cco-tune` | `./` (project local) | Project context + rules + statusline + permissions |
| `cco-remove` | Both | Global + local cleanup |

### Global vs Local

**cco-setup installs global files:**
- `~/.claude/rules/cco/core.md` - Core rules (always loaded)
- `~/.claude/rules/cco/ai.md` - AI behavior rules (always loaded)
- `~/.claude/commands/cco-*.md` - CCO commands (with embedded tool rules)
- `~/.claude/agents/cco-*.md` - CCO agents (with embedded tool rules)

**cco-tune creates local project files:**
- `./.claude/rules/cco/context.md` - Project strategic context (always loaded)
- `./.claude/rules/cco/{category}.md` - Path-specific rules with YAML frontmatter
- `./.claude/statusline.js` - Local statusline script (Full or Minimal)
- `./.claude/settings.json` - Local settings (AI Performance + Statusline + Permissions)

**Local settings.json merges all configurations:**
```json
{
  "env": {
    "MAX_THINKING_TOKENS": "{detected}",
    "MAX_MCP_OUTPUT_TOKENS": "{detected}",
    "DISABLE_PROMPT_CACHING": "0"
  },
  "statusLine": { "type": "command", "command": "...", "padding": 1 },
  "permissions": { "allow": [...], "deny": [...] }
}
```

All values are auto-detected based on project complexity. See [AI Performance Auto-Detection](#ai-performance-auto-detection).

### Content Sources

Statusline and permissions are installed via `cco-setup --local` command:

```bash
# Install statusline (mode: full or minimal)
cco-setup --local . --statusline full

# Install permissions (level: safe, balanced, permissive, or full)
cco-setup --local . --permissions balanced

# Install both at once
cco-setup --local . --statusline full --permissions balanced
```

| Content | Source | Target |
|---------|--------|--------|
| Statusline Full | `content/statusline/full.js` | `.claude/statusline.js` |
| Statusline Minimal | `content/statusline/minimal.js` | `.claude/statusline.js` |
| Permissions Safe | `content/permissions/safe.json` | `.claude/settings.json` |
| Permissions Balanced | `content/permissions/balanced.json` | `.claude/settings.json` |
| Permissions Permissive | `content/permissions/permissive.json` | `.claude/settings.json` |
| Permissions Full | `content/permissions/full.json` | `.claude/settings.json` |

**IMPORTANT:** cco-tune uses `cco-setup --local` via Bash tool to install statusline and permissions. This ensures templates are always read from the installed package, not generated by AI.

Global `~/.claude/` files are never modified by cco-tune.

## Usage

```bash
/cco-tune              # Show status, then choose: Configure / Remove / Export
```

---

## Flow Overview

**Status first, all questions at start, uninterrupted execution after.**

```
1. STATUS     → Always show current project state first
2. CHOOSE     → Configure / Remove / Export + ALL sub-questions
3. DETECT     → Run detection (if Configure selected)
4. REVIEW     → Accept/Edit/Cancel (single confirmation)
5. APPLY      → Write configurations, remove items, export files
6. REPORT     → Summary with all changes
```

---

## Step 1: Status (Always Runs)

Show current project state before asking anything. Status shows **current values and locations only** - no reasoning (that comes in detection results).

### 1.1 Count Rules First (MANDATORY)

**CRITICAL:** Before displaying status, you MUST run these commands and use the EXACT results. NEVER estimate or guess.

```bash
# Run these commands via Bash tool:
# Rules use list format: - **Name**: Description (Name can have hyphens like Type-Hints)
# OR table format (adaptive): | * Name | Check | Description |

# Core rules (from ~/.claude/rules/cco/core.md)
# Pattern matches: - **Word-Word**: or - **Word**:
grep -cE "^- \*\*[A-Za-z][-A-Za-z0-9]*\*\*:" ~/.claude/rules/cco/core.md 2>/dev/null || echo "0"
# → CORE (e.g., 26)

# AI rules (from ~/.claude/rules/cco/ai.md)
grep -cE "^- \*\*[A-Za-z][-A-Za-z0-9]*\*\*:" ~/.claude/rules/cco/ai.md 2>/dev/null || echo "0"
# → AI (e.g., 21)

# Project rules (from ./.claude/rules/cco/*.md files, excluding context.md which has no rules)
for f in ./.claude/rules/cco/*.md; do
  [ "$(basename "$f")" != "context.md" ] && grep -cE "^- \*\*[A-Za-z][-A-Za-z0-9]*\*\*:" "$f" 2>/dev/null
done | awk '{sum+=$1} END {print sum+0}'
# → PROJECT (e.g., 15-20) - returns 0 if no rules

# Alternative: count with file names
for f in ./.claude/rules/cco/*.md; do
  [ "$(basename "$f")" != "context.md" ] && echo -n "$(basename "$f"): " && grep -cE "^- \*\*[A-Za-z][-A-Za-z0-9]*\*\*:" "$f" 2>/dev/null || echo "0"
done
```

**Calculate totals:**
- `BASE = CORE + AI` (always loaded from ~/.claude/rules/cco/)
- `ON_DEMAND = TOOLS` (loaded by commands when needed)
- `PROJECT = rules in ./.claude/rules/cco/` (project-specific)

### 1.2 Display Status

```
╔════════════════════════════════════════════════════════════════════════════════╗
║                              CCO PROJECT STATUS                                ║
╠════════════════════════════════════════════════════════════════════════════════╣
║ PROJECT: {project_name}                                                        ║
╠════════════════════════════════════════════════════════════════════════════════╣
║ CONTEXT (./.claude/rules/cco/context.md)                                           ║
├────────────────────────────────────────────────────────────────────────────────┤
║ Purpose         │ {purpose}                                                    ║
║ Team/Scale/Data │ {team} | {scale} | {data}                                    ║
║ Stack/Type      │ {stack} | {type}                                             ║
║ Maturity        │ {maturity} | Breaking: {breaking} | Priority: {priority}     ║
╠════════════════════════════════════════════════════════════════════════════════╣
║ PROJECT RULES (./.claude/rules/cco/)                                               ║
├────────────────────────────────────────────────────────────────────────────────┤
║ {list of .md files: context.md, cli.md, operations.md, etc.}                   ║
╠════════════════════════════════════════════════════════════════════════════════╣
║ ACTIVE SETTINGS (./.claude/settings.json)                                      ║
├────────────────┬───────────────────────────────────────────────────────────────┤
║ Thinking       │ {value} tokens                                                ║
║ MCP Output     │ {value} tokens                                                ║
║ Caching        │ {on|off}                                                      ║
║ Statusline     │ {Full|Minimal|Broken|None}              ./.claude/statusline.js║
║ Permissions    │ {level} ({N} rules)                                           ║
╠════════════════════════════════════════════════════════════════════════════════╣
║ RULES          │ {BASE_TOTAL} base + {PROJECT_SPECIFIC} project = {TOTAL}      ║
╚════════════════════════════════════════════════════════════════════════════════╝
```

**Statusline status determination (run verification before display):**
- `Full` or `Minimal`: All 4 verification checks pass (see [Statusline Verification](#statusline-verification-critical))
- `Broken`: settings.json references statusline but verification fails
- `None`: No statusLine config in settings.json

**If no context exists (first run):**

```
╔════════════════════════════════════════════════════════════════════════════════╗
║                              CCO PROJECT STATUS                                ║
╠════════════════════════════════════════════════════════════════════════════════╣
║ PROJECT: {project_name}                                                        ║
╠════════════════════════════════════════════════════════════════════════════════╣
║ CONTEXT         │ Not configured                                               ║
║ ACTIVE SETTINGS │ Not configured                                               ║
║ RULES           │ {BASE_TOTAL} base only (no project-specific)                 ║
╚════════════════════════════════════════════════════════════════════════════════╝
```

---

## Step 2: Choose Actions + Configure

Based on status, show options with smart defaults. **All configuration questions are asked in this step.**

Follow CCO "Question Formatting" rule.

### Main Question (Single multiSelect)

| Question | Options (multiSelect) |
|----------|----------------------|
| What to configure? | *See grouped options below* |

**Grouped Options:**

```
┌─ Configure ────────────────────────────────────────────────────────┐
│ ☐ Detection & Rules        Scan project, write to .claude/rules/cco/   │
│ ☐ AI Performance           Configure thinking/MCP tokens           │
│ ☐ Statusline               Configure status bar                    │
│ ☐ Permissions              Configure permission rules              │
├─ Remove ───────────────────────────────────────────────────────────┤
│ ☐ Remove AI Performance    Reset to Claude Code defaults           │
│ ☐ Remove Statusline        Delete statusline.js, disable bar       │
│ ☐ Remove Permissions       Remove all permission rules             │
│ ☐ Remove Rules             Delete .claude/rules/cco/ + clean CLAUDE.md  │
├─ Export (rules only, no settings) ─────────────────────────────┤
│ ☐ CLAUDE.md                Rules for other Claude Code projects      │
│ ☐ AGENTS.md                Rules for other AI tools (Cursor)        │
├────────────────────────────────────────────────────────────────────┤
│ ☐ Nothing                  Exit without changes                    │
└────────────────────────────────────────────────────────────────────┘
```

**Dynamic visibility:**
- Remove options only shown if corresponding item is currently configured
- If nothing is configured, Remove section is hidden

**`[recommended]` placement:** First run (no context) → "Detection & Rules"

**Conflict Rule:** If same item selected for both Configure AND Remove → Configure wins (user wants to reconfigure)

**Execution Order:**
1. Remove operations (clean first)
2. Configure operations (then set up)
3. Export (last)

**Notes:**
- Detection includes AI Performance auto-calculation (see [AI Performance Auto-Detection](#ai-performance-auto-detection))
- AI Performance option is for manual override only
- **cco-tune NEVER modifies global ~/.claude/ files**

**Configure = Update behavior:**
- Selecting any Configure option when that item already exists → overwrites with fresh content
- This applies to ALL configurable items: Detection, AI Performance, Statusline, Permissions
- No separate "Update" action needed - Configure always installs fresh from source templates
- When item exists, `[recommended]` defaults to current value (for continuity)

### Inline Configuration Questions

Follow CCO "Question Formatting" rule for all questions below.

**If AI Performance selected:**

| Question | Options | `[recommended]` when |
|----------|---------|---------------------|
| Thinking Tokens? | Standard (5000); Medium (8000); High (10000) | complexity score: 0→Standard, 1-2→Medium, 3+→High |
| MCP Output Tokens? | Standard (25000); Large (35000); Very Large (50000) | files: <100→Standard, 100-500→Large, 500+→Very Large |
| Prompt Caching? | Off; On | always→On |

See [AI Performance Auto-Detection](#ai-performance-auto-detection) for scoring logic.

**If Statusline selected:**

| Question | Options | `[recommended]` when |
|----------|---------|---------------------|
| Statusline mode? | Minimal; Full | first-time→Full; exists→current mode |

**If Permissions selected:**

| Question | Options | `[recommended]` when |
|----------|---------|---------------------|
| Permission level? | Safe; Balanced; Permissive; Full | see table below; exists→current level |

**If CLAUDE.md or AGENTS.md export selected:**

| Question | Options (multiSelect) | Default |
|----------|----------------------|---------|
| What to include in export? | *See below* | All selected |

**Export content options:**

```
┌─ Rules ───────────────────────────────────────────────────────────┐
│ ☐ Universal Rules          Core principles for all projects        │
│ ☐ AI-Specific Rules        AI behavior and output rules            │
│ ☐ CCO-Specific Rules       CCO workflow mechanisms (CLAUDE.md only)│
├─ Project ──────────────────────────────────────────────────────────┤
│ ☐ Project Context          Strategic context (team, scale, etc.)   │
│ ☐ Conditional Rules    Project-specific rules              │
├────────────────────────────────────────────────────────────────────┤
│ ☐ All                      Include everything available            │
└────────────────────────────────────────────────────────────────────┘
```

**Notes:**
- CCO-Specific Rules only available for CLAUDE.md export (not portable)
- Project Context and Conditional Rules require `./.claude/rules/cco/` to exist
- "All" is pre-selected by default

**Permissions `[recommended]` (first match wins):**

| Condition | Recommended |
|-----------|-------------|
| Data: Regulated OR Compliance: Any | Safe |
| Data: PII or Confidential | Safe |
| Team: 2+ (not Solo) | Balanced |
| Team: Solo + Data: Public | Full |
| Default | Balanced |

After all questions answered → proceed to detection/apply (no more questions)

---

## Step 3: Detection (if selected)

**Output:** `./.claude/rules/cco/` (context.md + category files)

**IMPORTANT:** Detection always scans from scratch. Each element is freshly detected from actual project files. The Source column shows where the value was found.

### Detection Exclusions

**Always exclude these directories from infrastructure detection:**

| Category | Excluded Paths |
|----------|----------------|
| Version Control | `.git/`, `.svn/`, `.hg/` |
| Dependencies | `node_modules/`, `vendor/`, `third_party/`, `.venv/`, `venv/` |
| Build Output | `dist/`, `build/`, `out/`, `target/`, `.next/`, `__pycache__/` |
| Test/Examples | `benchmarks/`, `examples/`, `samples/`, `demo/`, `fixtures/`, `testdata/` |
| Temporary | `tmp/`, `temp/`, `.tmp/`, `.cache/` |
| IDE/Editor | `.idea/`, `.vscode/`, `.vs/` |

**Detection scope:**
- Only scan **project root** and **main source directories** (src/, lib/, app/, pkg/)
- Files in excluded paths should NOT trigger rules
- Exception: `.github/workflows/` IS scanned for CI/CD detection

**Example:**
- `./Dockerfile` → triggers Container rules ✓
- `./benchmarks/Dockerfile` → ignored (test/example) ✗
- `./examples/docker-compose.yml` → ignored (sample code) ✗

### Auto-Detect Elements

Every detection triggers a specific action. No detection is informational-only.

#### Core Detection (Always Run)

| # | Element | Detection Method | Confidence | Action |
|---|---------|------------------|------------|--------|
| 1 | Purpose | README.md first H1/paragraph | HIGH if found | → Context purpose field |
| 2 | Stack | package.json, pyproject.toml, go.mod, Cargo.toml | HIGH | → Language rules ({lang}.md) + context + tools |
| 3 | Type | Entry points vs exports analysis | HIGH | → CLI or Library rules (evaluate each) |
| 4 | License | LICENSE, LICENSE.md, package.json license | HIGH if found | → Context, compliance check |

#### Infrastructure Detection

| # | Element | Detection Method | Confidence | Action |
|---|---------|------------------|------------|--------|
| 5 | CI/CD | .github/workflows/, .gitlab-ci.yml, .circleci/ | HIGH | → Operations rules (evaluate each) |
| 6 | Container | Dockerfile, docker-compose.yml | HIGH | → Container rules (evaluate each) |
| 7 | K8s | k8s/, helm/, kustomization.yaml, *-deployment.yaml | HIGH | → Container rules + complexity score +1 |
| 8 | Serverless | serverless.yml, sam.yaml, netlify.toml, vercel.json | HIGH | → Serverless rules (evaluate each) |
| 9 | Monorepo | nx.json, turbo.json, lerna.json, pnpm-workspace.yaml | HIGH | → Monorepo rules + MCP tier bump |

#### Backend Detection

| # | Element | Detection Method | Confidence | Action |
|---|---------|------------------|------------|--------|
| 10 | DB | ORM deps, migrations/, connection strings, prisma/schema | HIGH | → Data rules (evaluate each) |
| 11 | API:REST | routes/, endpoints/, @Get/@Post decorators, OpenAPI | HIGH | → API rules (evaluate each) |
| 12 | API:GraphQL | graphql deps, schema.graphql, resolvers/ | HIGH | → API + GraphQL rules |
| 13 | API:gRPC | .proto files, grpc deps | HIGH | → API + gRPC rules |
| 14 | API:WebSocket | ws/socket.io deps, @WebSocket decorators | HIGH | → Real-time rules (evaluate each) |
| 15 | Microservices | Multiple */Dockerfile or services/ with separate configs | HIGH | → Scale & Arch rules |

#### Frontend/Apps Detection

| # | Element | Detection Method | Confidence | Action |
|---|---------|------------------|------------|--------|
| 16 | Frontend | react/vue/angular/svelte in deps | HIGH | → Frontend rules (evaluate each) |
| 17 | Mobile | Podfile, android/build.gradle, pubspec.yaml | HIGH | → Mobile rules (evaluate each) |
| 18 | Desktop | electron/tauri deps | HIGH | → Desktop rules (evaluate each) |

#### Specialized Detection

| # | Element | Detection Method | Confidence | Action |
|---|---------|------------------|------------|--------|
| 19 | ML/AI | torch, tensorflow, sklearn, transformers deps | HIGH | → ML/AI rules + complexity +1 |
| 20 | Game | Unity/, *.unity, Unreal/, *.uproject, Godot/ | HIGH | → Game rules (evaluate each) |
| 21 | i18n | locales/, i18n/, messages/, translations/ | HIGH | → i18n rules (evaluate each) |

#### Dependency-Based Detection [CRITICAL]

**ALWAYS scan project dependencies from manifest files.** This catches domain-specific patterns that file structure alone cannot detect.

| # | Element | Detection Method (deps in manifest) | Confidence | Action |
|---|---------|-------------------------------------|------------|--------|
| **Compute & Processing** ||||
| 22 | DEP:GPU | cuda-python, cupy, torch+cuda, tensorflow-gpu, numba, triton, jax | HIGH | → gpu.md rules |
| 23 | DEP:Audio | faster-whisper, whisper, pydub, librosa, soundfile, pyaudio | HIGH | → audio.md rules |
| 24 | DEP:Video | ffmpeg-python, moviepy, opencv (VideoCapture), decord, av | HIGH | → video.md rules |
| 25 | DEP:Image | opencv-python, pillow, scikit-image, albumentations, kornia | HIGH | → image.md rules |
| 26 | DEP:HeavyModel | transformers, langchain, llama-cpp, vllm, ollama, openai, anthropic | HIGH | → heavy-model.md rules |
| 27 | DEP:DataHeavy | pandas, polars, dask, pyspark, ray, vaex, arrow | HIGH | → data-heavy.md rules |
| **Game Development** ||||
| 28 | DEP:GamePython | pygame, arcade, ursina, panda3d, pyglet, raylib | HIGH | → game-python.md rules |
| 29 | DEP:GameJS | phaser, three.js, pixi.js, babylon.js, kaboom | HIGH | → game-js.md rules |
| 30 | DEP:GameEngine | Unity (.csproj), Unreal (*.uproject), Godot (project.godot) | HIGH | → game-engine.md rules |
| **Web & API** ||||
| 31 | DEP:HTTP | requests, httpx, aiohttp, axios, got, ky | HIGH | → http-client.md rules |
| 32 | DEP:ORM | sqlalchemy, prisma, drizzle, typeorm, sequelize, peewee | HIGH | → orm.md rules |
| 33 | DEP:Auth | authlib, next-auth, clerk, auth0, supabase-auth, passlib | HIGH | → auth.md rules |
| 34 | DEP:Payment | stripe, paypal, square, paddle, braintree | HIGH | → payment.md rules |
| **Communication** ||||
| 35 | DEP:Email | sendgrid, mailgun, resend, nodemailer, postmark | HIGH | → email.md rules |
| 36 | DEP:Search | elasticsearch, meilisearch, algolia, typesense | HIGH | → search.md rules |
| **Infrastructure** ||||
| 37 | DEP:Queue | celery, rq, dramatiq, bull, bullmq | HIGH | → queue.md rules |
| 38 | DEP:Cache | redis, memcached, aiocache, diskcache, ioredis | HIGH | → cache.md rules |
| 39 | DEP:Logging | loguru, structlog, winston, pino | HIGH | → logging.md rules |
| 40 | DEP:ObjectStore | boto3/s3, minio, cloudinary, uploadthing | HIGH | → object-store.md rules |
| **Documents** ||||
| 41 | DEP:PDF | reportlab, weasyprint, pdfkit, puppeteer (pdf) | HIGH | → pdf.md rules |
| **Emerging Tech** ||||
| 42 | DEP:Blockchain | web3, ethers, hardhat, brownie, solana-py | HIGH | → blockchain.md rules |
| 43 | DEP:ARVR | openxr, webxr, ar-foundation | HIGH | → arvr.md rules |
| 44 | DEP:IoT | micropython, paho-mqtt, esphome | HIGH | → iot.md rules |
| **Security** ||||
| 45 | DEP:Scraping | scrapy, beautifulsoup4, selenium, playwright, puppeteer | HIGH | → scraping.md rules |

**Dependency Scanning Command (Python example):**
```bash
# Extract deps from pyproject.toml
grep -A 100 '\[project.dependencies\]' pyproject.toml 2>/dev/null | grep -E "^[a-z]" | cut -d'=' -f1 | tr -d ' "'

# Or from requirements.txt
cat requirements.txt 2>/dev/null | grep -v "^#" | cut -d'=' -f1 | cut -d'>' -f1 | cut -d'<' -f1 | tr -d ' '

# For package.json
jq -r '.dependencies // {} | keys[]' package.json 2>/dev/null
```

**Multiple categories can match:** A project with `faster-whisper` + `cuda` triggers both DEP:Audio AND DEP:GPU rules.

#### Quality & Security Detection

| # | Element | Detection Method | Confidence | Action |
|---|---------|------------------|------------|--------|
| 22 | Test Framework | pytest/jest/vitest/mocha config or deps | HIGH | → Testing level hint |
| 23 | Coverage | coverage reports, pytest-cov, nyc, c8 | HIGH | → Context coverage %, testing tier |
| 24 | Linting | .eslintrc, ruff.toml, .pylintrc, golangci.yaml | HIGH | → Operational tools |
| 25 | Formatting | prettier, black, ruff format, gofmt config | HIGH | → Operational tools |
| 26 | Pre-commit | .pre-commit-config.yaml | HIGH | → Context hooks field |
| 27 | Security Scan | dependabot.yml, .snyk, trivy.yaml, codeql | HIGH | → Security posture |
| 28 | Secrets Risk | .env with values, hardcoded API keys, credentials | HIGH | → Security rules (evaluate each) |

#### Inferred Detection (Heuristics)

| # | Element | Detection Method | Confidence | Action |
|---|---------|------------------|------------|--------|
| 29 | Team Size | `git shortlog -sn --all` unique authors | MEDIUM | → Team guidelines, permission level |
| 30 | Scale | replicas config, HPA, load balancer, CDN config | MEDIUM | → Scale guidelines, caching rules |
| 31 | Maturity | First commit age, release frequency, CHANGELOG | MEDIUM | → Maturity guidelines |
| 32 | Breaking | Version in config (0.x vs 1.x+) | MEDIUM | → Breaking policy guideline |
| 33 | Data Sensitivity | auth/, login/, encryption usage, GDPR keywords | LOW | → Data guidelines, security weight |
| 34 | Compliance | SECURITY.md, security scans in CI, audit logs | LOW | → Compliance hint |

#### AI Performance (Auto-Calculated)

| # | Element | Detection Method | Action |
|---|---------|------------------|--------|
| 35 | Thinking Tokens | Complexity score from #7,9,15,19 | → settings.json env |
| 36 | MCP Output | File count + monorepo detection | → settings.json env |
| 37 | Caching | Always on unless explicitly disabled | → settings.json env |

**GRANULAR SELECTION [CRITICAL]:**

Each detection triggers a category in adaptive.md. For each triggered category:
1. Read ALL rules in that category from `cco-adaptive.md`
2. Check "Applicability Check" column for each rule
3. Include ONLY rules where the check passes for THIS project
4. Skip rules where the check does not apply

**IMPORTANT: Read the actual adaptive.md file** - Do NOT rely on memory or estimates. The source file is at:
- Package: `claudecodeoptimizer/content/rules/cco-adaptive.md`
- Use Glob/Read tools to find and read it

### Detection → Rules Mapping (from adaptive.md)

Each detection maps to a specific section in `cco-adaptive.md`. Read these sections:

| Detection | adaptive.md Section | Output File | Expected Rules |
|-----------|---------------------|-------------|----------------|
| **Language/Stack (ALWAYS evaluate when detected)** ||||
| L:Python | `### Python (L:Python)` | `python.md` | Type-Hints, Docstrings, Import-Order, Exception-Context |
| L:TypeScript | `### TypeScript (L:TypeScript)` | `typescript.md` | Strict-Mode, Explicit-Return, No-Any, Null-Safety |
| L:JavaScript | `### JavaScript (L:JavaScript)` | `javascript.md` | JSDoc-Types, ES-Modules, Const-Default |
| L:Go | `### Go (L:Go)` | `go.md` | Error-Wrap, Interface-Small, Goroutine-Safe, Defer-Cleanup |
| L:Rust | `### Rust (L:Rust)` | `rust.md` | Result-Propagate, Ownership-Clear, Clippy-Clean, Unsafe-Minimize |
| **Application Type** ||||
| T:CLI | `## Apps > CLI` | `cli.md` | Help-Examples, Exit-Codes, Signal-Handle, Output-Modes, Config-Precedence |
| T:Library | `## Apps > Library` | `library.md` | Minimal-Deps, Tree-Shakeable, Types-Included, Deprecation-Path |
| **Scale (ALWAYS evaluate - default Small for non-prototype)** ||||
| S:Small (100+) | `### Small (S:100+)` | `scale.md` | Caching, Lazy-Load |
| S:Medium (1K+) | `### Medium (S:1K+)` | `scale.md` | + Conn-Pool, Async-IO |
| S:Large (10K+) | `### Large (S:10K+)` | `scale.md` | + Circuit-Breaker, Idempotency, API-Version, Compression |
| **Operations** ||||
| CI/CD (CLI/Library) | `### CI-Only Operations` | `operations.md` | Config-as-Code, CI-Gates |
| CI/CD (API/Frontend) | `### Full Operations` | `operations.md` | Config-as-Code, Health-Endpoints, Graceful-Shutdown, Observability, CI-Gates, Zero-Downtime, Feature-Flags |
| **Testing** ||||
| Testing:Basics | `### Basics` | `testing.md` | Unit-Isolated, Mocking, Coverage-60 |
| Testing:Standard | `### Standard` | `testing.md` | + Integration, Fixtures, Coverage-80, CI-on-PR |
| Testing:Full | `### Full` | `testing.md` | + E2E, Contract, Mutation, Coverage-90 |
| **Infrastructure** ||||
| Container | `## Infrastructure > Container` | `container.md` | Multi-Stage, Non-Root, CVE-Scan, Resource-Limits, Distroless |
| K8s | `## Infrastructure > K8s` | `k8s.md` | Security-Context, Network-Policy, Probes, Resource-Quotas |
| Serverless | `## Infrastructure > Serverless` | `serverless.md` | Minimize-Bundle, Graceful-Timeout, Stateless, Right-Size |
| Monorepo | `## Infrastructure > Monorepo` | `monorepo.md` | Package-Boundaries, Selective-Test, Shared-Deps, Build-Cache |
| **Backend** ||||
| API:REST | `## Backend > API` | `api.md` | REST-Methods, Pagination, OpenAPI-Spec, Error-Format |
| API:GraphQL | `### GraphQL Extension` | `api.md` | + GQL-Limits, GQL-Persisted |
| API:gRPC | `### gRPC Extension` | `api.md` | + Proto-Version |
| DB:* | `## Backend > Data` | `database.md` | Backup-Strategy, Migration-Safe, N+1-Prevent, Transaction-Safe |
| **Frontend/Apps** ||||
| Frontend | `## Frontend` | `frontend.md` | A11y-WCAG, Perf-Core-Vitals, State-Predictable, Code-Split |
| Mobile | `## Apps > Mobile` | `mobile.md` | Offline-First, Battery-Optimize, Deep-Links, Platform-Guidelines |
| Desktop | `## Apps > Desktop` | `desktop.md` | Auto-Update, Native-Integration, Memory-Cleanup |
| **Specialized** ||||
| ML/AI | `## Specialized > ML/AI` | `ml-ai.md` | Reproducibility, Experiment-Track, Model-Registry, Bias-Detection |
| Game | `## Specialized > Game` | `game.md` | Frame-Budget, Asset-Streaming, Input-Rebind, Save-Versioned |
| i18n | `## i18n` | `i18n.md` | Strings-External, UTF8-Encoding, RTL-Support, Locale-Format |
| **Real-time** ||||
| RT:Basic | `### Basic (RT:Basic)` | `realtime.md` | Reconnect-Logic, Heartbeat, Stale-Data |
| RT:Low-latency | `### Low-Latency` | `realtime.md` | + Binary-Protocol, Edge-Compute |
| **Team** ||||
| Team:Small | `### Small (Team:2-5)` | `team.md` | PR-Review, README-Contributing |
| Team:Large | `### Large (Team:6+)` | `team.md` | + ADR, CODEOWNERS, PR-Templates, Branch-Protection |
| **Observability/SLA** ||||
| SLA:Any | `### Basics (SLA:Any)` | `observability.md` | Error-Tracking, Critical-Alerts |
| SLA:99%+ | `### Standard (SLA:99%+)` | `observability.md` | + Structured-Logs, RED-Metrics, Distributed-Trace |
| SLA:99.9%+ | `### HA (SLA:99.9%+)` | `observability.md` | + Redundancy, Auto-Failover, Runbooks |
| SLA:99.99%+ | `### Critical (SLA:99.99%+)` | `observability.md` | + Multi-Region, Chaos-Engineering, DR-Tested |
| **Security** ||||
| D:PII/Regulated | `## Security` | `security.md` | Input-Validation, SQL-Safe, XSS-Prevent, Auth-Verify, Rate-Limit, Encrypt-Rest, Audit-Log, CORS-Strict, License-Track |
| **Dependency-Based (scan manifest files)** ||||
| **Compute & Processing** ||||
| DEP:GPU | `### GPU (DEP:GPU)` | `gpu.md` | Device-Selection, Memory-Management, Batch-Sizing, Mixed-Precision, Fallback-CPU, Stream-Async |
| DEP:Audio | `### Audio (DEP:Audio)` | `audio.md` | Chunk-Processing, Sample-Rate, Format-Agnostic, Memory-Stream, Silence-Detection, Progress-Callback |
| DEP:Video | `### Video (DEP:Video)` | `video.md` | Frame-Iterator, Codec-Fallback, Resolution-Aware, Temp-Cleanup, Seek-Efficient, Hardware-Accel |
| DEP:Image | `### Image Processing (DEP:Image)` | `image.md` | Lazy-Decode, Size-Validate, Format-Preserve, EXIF-Handle, Memory-Map |
| DEP:HeavyModel | `### Heavy Models (DEP:HeavyModel)` | `heavy-model.md` | Lazy-Model-Load, Model-Singleton, Quantization-Aware, Batch-Inference, Timeout-Guard, Memory-Cleanup, Download-Cache |
| DEP:DataHeavy | `### Data Heavy (DEP:DataHeavy)` | `data-heavy.md` | Chunk-Read, Lazy-Eval, Type-Optimize, Index-Usage, Parallel-Process, Spill-Disk |
| **Game Development** ||||
| DEP:GamePython | `### Game Python (DEP:GamePython)` | `game-python.md` | Game-Loop, Asset-Preload, Input-Mapping, State-Machine, Delta-Time |
| DEP:GameJS | `### Game JS (DEP:GameJS)` | `game-js.md` | Sprite-Atlas, Object-Pool, RAF-Loop, WebGL-Fallback, Audio-Context |
| DEP:GameEngine | `### Game Engine (DEP:GameEngine)` | `game-engine.md` | Scene-Organization, Prefab-Usage, Build-Profiles, Version-Control, Performance-Budget |
| **Web & API** ||||
| DEP:HTTP | `### HTTP Client (DEP:HTTP)` | `http-client.md` | Timeout-Always, Retry-Transient, Session-Reuse, Error-Handle, Response-Validate |
| DEP:ORM | `### ORM (DEP:ORM)` | `orm.md` | Migration-Always, Query-Optimize, Relationship-Lazy, Transaction-Scope, Index-Define |
| DEP:Auth | `### Auth (DEP:Auth)` | `auth.md` | Token-Secure, Refresh-Flow, RBAC-Clear, Session-Invalidate, MFA-Support |
| DEP:Payment | `### Payment (DEP:Payment)` | `payment.md` | Webhook-Verify, Idempotency-Key, Amount-Server, Error-Handle, Audit-Trail |
| **Communication** ||||
| DEP:Email | `### Email (DEP:Email)` | `email.md` | Template-System, Queue-Async, Bounce-Handle, Rate-Aware, Unsubscribe |
| DEP:SMS | `### SMS (DEP:SMS)` | `sms.md` | Delivery-Status, Rate-Throttle, Opt-Out, Fallback-Provider, Message-Template |
| DEP:Notification | `### Notification (DEP:Notification)` | `notification.md` | Channel-Preference, Batch-Send, Silent-Push, Token-Refresh, Fallback-Channel |
| DEP:Search | `### Search (DEP:Search)` | `search.md` | Index-Strategy, Sync-Mechanism, Relevance-Tune, Typo-Tolerance, Facet-Design |
| **Infrastructure** ||||
| DEP:Queue | `### Queue/Workers (DEP:Queue)` | `queue.md` | Idempotent-Tasks, Result-Backend, Timeout-Task, Dead-Letter, Priority-Queues |
| DEP:Cache | `### Cache (DEP:Cache)` | `cache.md` | TTL-Strategy, Key-Namespace, Serialization, Cache-Aside, Invalidation |
| DEP:Logging | `### Logging (DEP:Logging)` | `logging.md` | Structured-Format, Level-Config, Context-Inject, Sensitive-Redact, Rotation-Strategy |
| DEP:ObjectStore | `### Object Store (DEP:ObjectStore)` | `object-store.md` | Presigned-URLs, Content-Type, Size-Limit, Path-Structure, Lifecycle-Rules |
| **Documents** ||||
| DEP:PDF | `### PDF (DEP:PDF)` | `pdf.md` | Template-Based, Async-Generate, Stream-Output, Font-Embed, Accessibility |
| DEP:Excel | `### Excel (DEP:Excel)` | `excel.md` | Stream-Write, Formula-Safe, Style-Template, Memory-Optimize, Sheet-Naming |
| **Emerging Tech** ||||
| DEP:Blockchain | `### Blockchain (DEP:Blockchain)` | `blockchain.md` | Gas-Estimate, Nonce-Manage, Event-Listen, Testnet-First, Key-Security |
| DEP:ARVR | `### AR/VR (DEP:ARVR)` | `arvr.md` | Frame-Budget, Comfort-Settings, Fallback-Mode, Input-Abstract, Performance-Tier |
| DEP:IoT | `### IoT (DEP:IoT)` | `iot.md` | Reconnect-Logic, Power-Aware, OTA-Update, Data-Buffer, Watchdog |
| **Security** ||||
| DEP:Crypto | `### Crypto (DEP:Crypto)` | `crypto.md` | Algorithm-Modern, Key-Rotation, IV-Unique, Timing-Safe, Key-Derivation |
| DEP:Scraping | `### Web Scraping (DEP:Scraping)` | `scraping.md` | Politeness-Delay, Robots-Respect, User-Agent-Honest, Selector-Resilient, Headless-Default, Anti-Block |

### Rule Selection Process

**MANDATORY EVALUATIONS [CRITICAL]:**
These categories MUST be evaluated for EVERY project, regardless of other detections:

1. **Language/Stack** - If pyproject.toml exists → MUST create python.md
   - If package.json exists → MUST create typescript.md or javascript.md
   - If go.mod exists → MUST create go.md
   - If Cargo.toml exists → MUST create rust.md

2. **Scale** - ALWAYS create scale.md (default: S:Small rules)
   - Only skip for explicit Prototype scale selection

3. **Testing** - If test framework detected → MUST create testing.md

```
1. Read cco-adaptive.md from package
2. FIRST: Evaluate mandatory categories (Language, Scale, Testing)
3. THEN: For each additional detection → find matching section in adaptive.md
4. Evaluate each rule's "Check" condition against project
5. Include rules where condition is met
6. Write to .claude/rules/cco/{category}.md files
```

**Example: faster-whisper CLI (Python + CLI + Scale:Small)**
Must generate:
- `python.md` (Language detection: pyproject.toml)
- `cli.md` (Type detection: __main__.py)
- `scale.md` (Scale: Small default - model loading = lazy load candidate)
- `testing.md` (if pytest detected)
- `operations.md` (if .github/workflows/ exists)

Multiple detections stack additively. Each rule is evaluated once (no duplicates).

### Confidence Levels

| Level | Symbol | Meaning | Review Behavior |
|-------|--------|---------|-----------------|
| HIGH | ●●● | Explicit file/config found | Auto-accept |
| MEDIUM | ●●○ | Pattern inference | Show in review, suggest confirm |
| LOW | ●○○ | Heuristic only | Highlight, prompt for edit |

**Review table shows confidence:** LOW items get ⚠ marker to draw attention.

---

### Smart Defaults

User-configurable elements get intelligent defaults based on detected context, not generic values.

#### Context-Aware Inference

| If Detected | Then Default | Rationale |
|-------------|--------------|-----------|
| No auth patterns, no login/ | Data: Public | No sensitive data handling |
| auth/, login/, user accounts | Data: PII | User data requires protection |
| `stripe`, `payment` in deps | Compliance: PCI-DSS hint | Payment processing |
| Healthcare keywords, HIPAA in docs | Compliance: HIPAA hint | Medical data |
| GDPR in docs, EU privacy patterns | Compliance: GDPR hint | EU users |
| Single Dockerfile at root | Architecture: Monolith | Single service |
| Multiple */Dockerfile | Architecture: Microservices | Multi-service |
| No Dockerfile, no k8s | Architecture: Monolith | Simple deployment |
| `argocd`, `flux` in config | Deployment: GitOps | GitOps pattern |
| Vercel/Netlify/Railway config | Deployment: Platform | PaaS deployment |
| .github/workflows/deploy* | Deployment: CI/CD | Pipeline deployment |
| 1 git author (90 days) | Team: Solo | Single contributor |
| 2-5 git authors | Team: Small | Small team |
| CODEOWNERS exists | Team: 2+ (not Solo) | Review required |
| Version 0.x in config | Breaking: Allowed | Pre-stable |
| Version 1.x+ in config | Breaking: Minimize | Stable API |
| First commit < 3 months | Maturity: Greenfield | New project |
| First commit > 2 years, low activity | Maturity: Legacy | Old codebase |
| No scaling config | Scale: Prototype or Small | Simple scale |
| HPA, replicas > 1 | Scale: Medium+ | Scaling needed |
| WebSocket deps | Real-time: Hard | Real-time required |
| No WS, no SSE | Real-time: None | Request-response only |

#### Default Derivation Chain

For each user-configurable element, apply in order:

1. **Explicit detection** (HIGH confidence) → Use detected value
2. **Context inference** (MEDIUM) → Use smart default from table above
3. **Safe fallback** (LOW) → Use conservative default, mark for review

**Example flow:**
```
Team Size:
  1. Check CODEOWNERS → if exists: Team 2+ (HIGH)
  2. Check git authors → if 1: Solo (MEDIUM)
  3. Fallback → Solo [needs review] (LOW)
```

---

### AI Performance Auto-Detection

AI Performance settings are **automatically calculated** based on detected project complexity.

> **Note:** Claude Code does not define fixed tiers. These are **CCO-recommended values** based on project complexity. Official docs only specify: MAX_MCP_OUTPUT_TOKENS default=25000, warning at 10000. MAX_THINKING_TOKENS is disabled by default.

#### Thinking Tokens (MAX_THINKING_TOKENS)

| Complexity | CCO Value | Detected When | Rationale |
|------------|-----------|---------------|-----------|
| High | 10000 | Microservices, Monorepo, Enterprise, Hyperscale | Complex multi-service reasoning |
| Medium | 8000 | K8s, ML/AI, Multiple APIs, Large team/scale | Multi-file changes |
| Standard | 5000 | CLI, Library, Monolith, Solo/Small team | Simple operations |

**Scoring Logic:**
- +2: Microservices detected
- +2: Monorepo detected
- +1: K8s/Helm detected
- +1: ML/AI detected
- +1: Multiple API styles (REST + GraphQL + gRPC)
- +1: Team size Large (16+) or Enterprise (51+)
- +1: Scale Large (100K+) or Hyperscale (1M+)

**Score → Value mapping (CCO defaults, adjust per project):**
- Score 0 → Standard tier
- Score 1-2 → Medium tier
- Score 3+ → High tier

#### MCP Output Tokens (MAX_MCP_OUTPUT_TOKENS)

| Codebase Size | CCO Value | Detected When | Rationale |
|---------------|-----------|---------------|-----------|
| Very Large | 50000 | Monorepo, Hyperscale, 500+ files | Large tool outputs |
| Large | 35000 | 100-500 files, Multiple services | Medium tool outputs |
| Standard | 25000 | <100 files (official default) | Default per docs |

**Scoring Logic:**
- File count via `find . -type f -name "*.{py,js,ts,go,rs}" | wc -l`
- Monorepo → Very Large tier
- 100-500 files → Large tier
- <100 files → Standard tier (official default)

#### Prompt Caching (DISABLE_PROMPT_CACHING)

| Setting | Value | When |
|---------|-------|------|
| Enabled | `"0"` or not set | Always recommended (reduces cost ~90%) |
| Disabled | `"1"` | Only if explicitly requested |

**Note:** All `env` values must be **strings**, not numbers or booleans.

**Official Reference:** https://code.claude.com/docs/en/settings

---

### User-Configurable Elements

Elements requiring user input. Follow CCO "Question Formatting" rule.

---

#### 1. Team Size

**Question:** How many people actively contribute to this codebase?

| Value | `[recommended]` when | Triggers |
|-------|---------------------|----------|
| Solo | no CODEOWNERS, 1 git author | Guidelines only |
| Small (2-5) | small CODEOWNERS | Team rules |
| Medium (6-15) | - | Team rules |
| Large (16-50) | - | Team + ADR |
| Enterprise (51+) | - | Team + Scaling |

**Detection hints:** CODEOWNERS file, git log unique authors

---

#### 2. Scale (Users/Load)

**Question:** How many concurrent users or requests per second does your system handle?

| Value | `[recommended]` when | Triggers |
|-------|---------------------|----------|
| Prototype (<100) | new project, no prod traffic | - |
| Small (100-1K) | - | Caching basics |
| Medium (1K-100K) | - | Scale & Arch |
| Large (100K-1M) | - | Scale + Security |
| Hyperscale (1M+) | - | Scale + Security + Performance |

---

#### 3. Data Sensitivity

**Question:** What is the most sensitive type of data your system processes?

| Value | `[recommended]` when | Triggers |
|-------|---------------------|----------|
| Public | no auth patterns | - |
| Internal | - | Auth basics |
| Confidential | - | Auth + Encryption |
| PII | user accounts detected | Security |
| Regulated | - | Security + Compliance |

---

#### 4. Compliance Requirements

**Question:** Which compliance frameworks must your system satisfy? (multi-select)

| Value | `[recommended]` when | Triggers |
|-------|---------------------|----------|
| None | B2C/internal tool | - |
| SOC2 | - | Security + Audit |
| HIPAA | healthcare detected | Security + PHI controls |
| PCI-DSS | payments detected | Security + PCI controls |
| GDPR | EU users detected | Security + Privacy |
| CCPA | - | Security + Privacy |
| ISO27001 | - | Security + ISMS |
| HITRUST | - | Security + Full audit |
| FedRAMP | - | Security + Gov controls |
| DORA | - | Security + Resilience |

---

#### 5. Architecture Pattern

**Question:** What is the primary architecture pattern of your system?

| Value | `[recommended]` when | `[detected]` when | Triggers |
|-------|---------------------|-------------------|----------|
| Monolith | small teams | single service | - |
| Modular Monolith | - | - | Bounded Contexts |
| Microservices | - | multiple services | Scale & Arch |
| Serverless | - | Lambda/Functions | Serverless |
| Hybrid | - | - | Context-dependent |

---

#### 6. API Style

**Question:** What API protocol does your system expose? (multi-select)

| Value | `[recommended]` when | `[detected]` when | Triggers |
|-------|---------------------|-------------------|----------|
| None | CLI/desktop type | - | - |
| REST | - | routes/endpoints | API |
| GraphQL | - | graphql deps | API + GraphQL |
| gRPC | - | proto files | API + gRPC |
| WebSocket | - | ws deps | Real-time |
| Webhook | - | - | Webhook patterns |

---

#### 7. Deployment Strategy

**Question:** How is your application deployed to production?

| Value | `[recommended]` when | `[detected]` when | Triggers |
|-------|---------------------|-------------------|----------|
| Manual | - | - | - |
| CI/CD | - | workflows exist | Operations |
| GitOps | - | argocd/flux config | Operations + GitOps |
| Platform | - | vercel/netlify config | Operations + Platform |

---

#### 8. Testing Strategy

**Question:** What level of testing does your project maintain?

| Value | `[recommended]` when | `[detected]` when | Triggers |
|-------|---------------------|-------------------|----------|
| Minimal | - | - | - |
| Unit | - | test framework | Testing basics |
| Standard | default | - | Testing |
| Comprehensive | - | - | Full testing |
| Performance | - | - | Testing + Performance |

---

#### 9. SLA Level

**Question:** What uptime commitment does your system have?

| Value | `[recommended]` when | Triggers |
|-------|---------------------|----------|
| None | internal tools | - |
| Standard (99%) | - | Monitoring basics |
| High (99.9%) | - | Observability |
| Critical (99.99%) | - | HA + DR |
| Mission-Critical (99.999%) | - | Full resilience |

---

#### 10. Real-time Requirements

**Question:** Does your system require real-time data updates?

| Value | `[recommended]` when | `[detected]` when | Triggers |
|-------|---------------------|-------------------|----------|
| None | CRUD apps | - | - |
| Soft (seconds) | - | - | Basic real-time |
| Hard (100ms) | - | websocket deps | Real-time |
| Ultra-low (<10ms) | - | - | Low-latency |

---

#### 11. Maturity Stage

**Question:** What is the current development stage of your project?

| Value | `[recommended]` when | `[detected]` when | Guidelines |
|-------|---------------------|-------------------|------------|
| Prototype | - | - | Move fast, skip docs |
| Greenfield | - | new repo (<3mo) | Aggressive refactoring OK |
| Active | default | recent commits | Balanced approach |
| Stable | - | - | Conservative changes |
| Legacy | - | old repo, low activity | Wrap don't modify |
| Sunset | - | - | Document for migration |

---

#### 12. Breaking Changes Policy

**Question:** How should breaking changes be handled?

| Value | `[recommended]` when | `[detected]` when | Guidelines |
|-------|---------------------|-------------------|------------|
| Allowed | - | version 0.x | Clean API over compat |
| Minimize | default | version 1.x+ | SemVer strictly |
| Never | - | - | Adapters required |

---

#### 13. Priority Focus

**Question:** What is the primary development priority?

| Value | `[recommended]` when | Guidelines |
|-------|---------------------|------------|
| Speed | - | MVP mindset |
| Balanced | default | Normal workflow |
| Quality | - | No shortcuts |
| Security | - | Threat modeling |
| Cost | - | Efficiency focus |

---

## Step 4: Review Detection Results

Show unified table with confidence indicators. **Every row shows what action it triggers.**

```
╔══════════════════════════════════════════════════════════════════════════════════════════════╗
║                                  CCO DETECTION RESULTS                                       ║
╠══════════════════════════════════════════════════════════════════════════════════════════════╣
║  #  │ Element       │ Value                │ Conf │ Source              │ Action            ║
╠═════╪═══════════════╪══════════════════════╪══════╪═════════════════════╪═══════════════════╣
║     │ CORE (always detected)                                                                 ║
├─────┼───────────────┼──────────────────────┼──────┼─────────────────────┼───────────────────┤
║  1  │ Purpose       │ {purpose}            │ ●●●  │ README.md:1         │ → context         ║
║  2  │ Stack         │ Python 3.10+         │ ●●●  │ pyproject.toml      │ → tools, context  ║
║  3  │ Type          │ CLI                  │ ●●●  │ __main__.py         │ → CLI rules   ║
║  4  │ License       │ MIT                  │ ●●●  │ LICENSE             │ → context         ║
╠═════╪═══════════════╪══════════════════════╪══════╪═════════════════════╪═══════════════════╣
║     │ INFRASTRUCTURE                                                                         ║
├─────┼───────────────┼──────────────────────┼──────┼─────────────────────┼───────────────────┤
║  5  │ CI/CD         │ GitHub Actions       │ ●●●  │ .github/workflows/  │ → Ops rules   ║
║  6  │ Container     │ -                    │ -    │ (not detected)      │ -                 ║
║  7  │ K8s           │ -                    │ -    │ (not detected)      │ -                 ║
╠═════╪═══════════════╪══════════════════════╪══════╪═════════════════════╪═══════════════════╣
║     │ QUALITY & SECURITY                                                                     ║
├─────┼───────────────┼──────────────────────┼──────┼─────────────────────┼───────────────────┤
║  8  │ Test Framework│ pytest               │ ●●●  │ pyproject.toml      │ → testing tier    ║
║  9  │ Coverage      │ 100%                 │ ●●●  │ .coverage           │ → context         ║
║ 10  │ Linting       │ ruff, mypy           │ ●●●  │ pyproject.toml      │ → tools           ║
║ 11  │ Pre-commit    │ -                    │ -    │ (not detected)      │ → hooks: none     ║
║ 12  │ Security Scan │ -                    │ -    │ (not detected)      │ -                 ║
║ 13  │ Secrets Risk  │ no                   │ ●●●  │ scan complete       │ -                 ║
╠═════╪═══════════════╪══════════════════════╪══════╪═════════════════════╪═══════════════════╣
║     │ AI PERFORMANCE (auto-calculated → ./.claude/settings.json)                             ║
├─────┼───────────────┼──────────────────────┼──────┼─────────────────────┼───────────────────┤
║ 14  │ Thinking      │ 5000 (Standard)      │ ●●●  │ complexity: 0       │ → env             ║
║ 15  │ MCP Output    │ 25000 (Standard)     │ ●●●  │ files: 47           │ → env             ║
║ 16  │ Caching       │ on                   │ ●●●  │ recommended         │ → env             ║
╠═════╪═══════════════╪══════════════════════╪══════╪═════════════════════╪═══════════════════╣
║     │ CONTEXT (smart defaults applied, editable)                                             ║
├─────┼───────────────┼──────────────────────┼──────┼─────────────────────┼───────────────────┤
║ 17  │ Team          │ Solo                 │ ●●○  │ 1 git author        │ → guidelines      ║
║ 18  │ Scale         │ Small (100-1K)       │ ●○○  │ (default)           │ → Caching     ⚠   ║
║ 19  │ Data          │ Public               │ ●●○  │ no auth patterns    │ → guidelines      ║
║ 20  │ Compliance    │ None                 │ ●○○  │ (default)           │ -             ⚠   ║
║ 21  │ Architecture  │ Monolith             │ ●●○  │ single service      │ → guidelines      ║
║ 22  │ Testing       │ Standard             │ ●●●  │ pytest + 100%       │ → Testing stds    ║
║ 23  │ Maturity      │ Active               │ ●●○  │ recent commits      │ → guidelines      ║
║ 24  │ Breaking      │ Minimize             │ ●●○  │ version 1.x         │ → guidelines      ║
║ 25  │ Priority      │ Quality              │ ●○○  │ (default)           │ → guidelines  ⚠   ║
╠══════════════════════════════════════════════════════════════════════════════════════════════╣
║ ⚠ LOW CONFIDENCE: Items 18, 20, 25 may need review                                          ║
╠══════════════════════════════════════════════════════════════════════════════════════════════╣
║ RULES TRIGGERED (each evaluated individually for relevance)                                  ║
├──────────────────────────────────────────────────────────────────────────────────────────────┤
║ CLI │ Operations │ Testing │ Caching = {N} project-specific (counted after evaluation)      ║
╠══════════════════════════════════════════════════════════════════════════════════════════════╣
║ TOTAL: {BASE_TOTAL} base + {PROJECT_SPECIFIC} project-specific = {TOTAL} rules           ║
╚══════════════════════════════════════════════════════════════════════════════════════════════╝
```

### Confidence Indicators

| Symbol | Level | Meaning | User Action |
|--------|-------|---------|-------------|
| ●●● | HIGH | Explicit file/config found | Auto-accepted |
| ●●○ | MEDIUM | Pattern inference | Review recommended |
| ●○○ | LOW | Heuristic/default | ⚠ Marked, prompt edit |
| - | N/A | Not detected | No action needed |

### Action Column Values

| Format | Meaning |
|--------|---------|
| `+N {category}` | Triggers N rules from category |
| `→ context` | Written to .claude/rules/context.md |
| `→ env` | Written to settings.json env section |
| `→ tools` | Added to Operational tools list |
| `→ guidelines` | Affects guidelines generation |
| `→ hooks: {value}` | Sets hooks field in context |
| `-` | No action (not detected or no impact) |

**Rule counts are calculated dynamically** from `adaptive.md` based on triggers.

### Review Options

After detection results table, show **Configuration Summary** box, then the approval question.

**Output sequence:**
1. Detection results table (shown above)
2. Configuration Summary box (markdown, before AskUserQuestion)
3. AskUserQuestion with approval options

**Configuration Summary box** (show user selections from Step 2):
```
┌─ CONFIGURATION SUMMARY ──────────────────────────────────────────┐
│ AI Performance: {thinking}/{mcp} tokens, caching {on|off}        │
│ Statusline:     {Full|Minimal|Disable}                           │
│ Permissions:    {Safe|Balanced|Permissive|Full}                  │
└──────────────────────────────────────────────────────────────────┘
```

Only show rows for options user selected in Step 2. If user didn't select AI Performance/Statusline/Permissions, omit those rows.

**Approval question** (AskUserQuestion):

| Question | Options |
|----------|---------|
| Apply this configuration? | Accept; Edit; Cancel |

**Option descriptions:**
- Accept: Apply configuration to project
- Edit: Change specific context items
- Cancel: Exit without changes

**If Edit selected**, ask which items to change:
```
┌─────────────────────────────────────────────────────────────────┐
│ Which items would you like to edit?                             │
├─────────────────────────────────────────────────────────────────┤
│ ☐ Edit all      Configure all editable items                    │
│ ☐ 21: Team      Currently: Solo                                 │
│ ☐ 22: Scale     Currently: <100                                 │
│ ☐ 23: Data      Currently: Public                               │
└─────────────────────────────────────────────────────────────────┘
```

- First option "Edit all" selects all editable items
- Other options show item number, name, and current value
- User selects which items to edit (multiSelect: true)
- Then show individual questions for each selected item

**For each selected item**, show options with recommendations and affected rules:

```
┌─────────────────────────────────────────────────────────────────┐
│ #{N} {element} - {question}?                                    │
├─────────────────────────────────────────────────────────────────┤
│ ○ {option_1}   [{current|detected}] {description}               │
│ ○ {option_2}   {description}                                    │
│ ○ {option_3}   {description}                                    │
│                                                                 │
│ Affects: {affected_categories}                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Step 5: Apply

Write all selected configurations to **project-local files only**:

### Configure Operations

| Selection | Target | Method |
|-----------|--------|--------|
| Detection | `./.claude/rules/cco/` + `./CLAUDE.md` cleanup | Write tool (context.md + category files) + Edit tool (remove ALL CCO markers) |
| AI Performance | `./.claude/settings.json` | Write tool (env section) |
| Statusline | `./.claude/statusline.js` + `./.claude/settings.json` | `cco-setup --local . --statusline {mode}` |
| Permissions | `./.claude/settings.json` | `cco-setup --local . --permissions {level}` |

**CLAUDE.md cleanup only** - Remove ALL CCO marker blocks (CCO_ADAPTIVE, CCO_CONTEXT, CCO_STANDARDS, etc.), add nothing new.

### Export Operations

| Selection | Source | Target | Method |
|-----------|--------|--------|--------|
| CLAUDE.md | `~/.claude/rules/cco/` + `./.claude/rules/cco/` | `./CLAUDE.export.md` | Read + combine + Write |
| AGENTS.md | `~/.claude/rules/cco/` + `./.claude/rules/cco/` | `./AGENTS.md` | Read + transform + Write |

**Export includes only user-selected content** from rules/ folders.

### Removal Operations

| Remove | Target | Method |
|--------|--------|--------|
| Remove Rules | `./.claude/rules/cco/` + `./CLAUDE.md` | Delete rules dir + remove ALL CCO marker blocks |
| Remove AI Performance | `./.claude/settings.json` | Remove `env` section from JSON |
| Remove Statusline | `./.claude/statusline.js` + `./.claude/settings.json` | Delete statusline.js, remove `statusLine` from JSON |
| Remove Permissions | `./.claude/settings.json` | Remove `permissions` section from JSON |

**Removal behavior:**
- Rules: Removes all `.md` files from `./.claude/rules/cco/` AND removes ALL CCO marker blocks from `./CLAUDE.md`
- AI Performance: Removes `env` key entirely → Claude Code uses built-in defaults
- Statusline: Deletes `.claude/statusline.js` file AND removes `statusLine` key from settings.json
- Permissions: Removes `permissions` key entirely → all operations require approval
- If settings.json becomes empty (`{}`), delete the file
- If `.claude/` directory becomes empty, optionally delete it

### CLAUDE.md Cleanup [CRITICAL]

**When Detection & Rules is selected, ALWAYS clean ALL CCO markers from CLAUDE.md:**

The new rule system stores project rules in `./.claude/rules/cco/`, NOT in `./CLAUDE.md`. Any existing CCO marker blocks in CLAUDE.md are legacy and MUST be removed.

**Supported legacy markers (all must be cleaned):**
- `CCO_ADAPTIVE_START/END` - current version
- `CCO_CONTEXT_START/END` - v1.0.0
- `CCO_STANDARDS_START/END` - v1.0.0
- Any `CCO_*_START/END` pattern

**Cleanup steps (run via Edit tool):**
1. Check if `./CLAUDE.md` contains any `<!-- CCO_*_START -->` marker (case-insensitive)
2. If found, remove ALL blocks matching `<!-- CCO_*_START -->...<!-- CCO_*_END -->`
3. Preserve any content BEFORE first CCO marker and AFTER last CCO marker
4. Do NOT add anything to CLAUDE.md - only remove

**Example transformation:**
```markdown
# MyProject                          # MyProject

<!-- CCO_CONTEXT_START -->     →     (ALL CCO blocks removed)
## Strategic Context
...
<!-- CCO_CONTEXT_END -->

<!-- CCO_ADAPTIVE_START -->
...
<!-- CCO_ADAPTIVE_END -->
```

**Bash command to check:**
```bash
grep -qiE "CCO_[A-Z]+_START" ./CLAUDE.md && echo "NEEDS_CLEANUP" || echo "CLEAN"
```

**IMPORTANT:** This cleanup is MANDATORY when:
- "Detection & Rules" is selected (new rules go to .claude/rules/cco/)
- "Remove Rules" is selected (full cleanup)

### Statusline & Permissions Installation

Use Bash tool to call `cco-setup --local`:

```bash
# If user selected statusline + permissions
cco-setup --local . --statusline {mode} --permissions {level}

# If user selected statusline only
cco-setup --local . --statusline {mode}

# If user selected permissions only
cco-setup --local . --permissions {level}
```

This ensures templates are read from the installed package, not generated by AI.

**CRITICAL - ALWAYS OVERWRITE:**
- Statusline: `.claude/statusline.js` → overwrite entirely with source template
- Permissions: `.claude/settings.json` permissions section → overwrite with source template
- AI Performance: `.claude/settings.json` env section → overwrite with user selections
- Context: `./.claude/rules/cco/context.md` → overwrite with detection results
- **Never skip** because "file exists", "content unchanged", or "already configured"

**IMPORTANT:** cco-tune NEVER modifies global `~/.claude/` files. All settings are project-local.

### Statusline Files

**Source:** `claudecodeoptimizer/content/statusline/`

| Mode | Source File | Output |
|------|-------------|--------|
| Full | `statusline/full.js` | `Project \| Branch \| Changes` |
| Minimal | `statusline/minimal.js` | `Project \| Branch` |
| Disable | Remove files | No statusline |

**Target:** `./.claude/statusline.js` + `statusLine` config in `./.claude/settings.json`

**Install Behavior:**
- ALWAYS overwrite `.claude/statusline.js` with fresh content from source template
- ALWAYS update `statusLine` config in `.claude/settings.json`
- Create `.claude/` directory if it doesn't exist
- Never skip because "file already exists" or "content looks same"

**Runtime Behavior (Claude Code):** Only executes if local `.claude/statusline.js` exists. No global fallback.

**Disable Mode:** Delete `.claude/statusline.js` and remove `statusLine` key from settings.json. Same behavior as "Remove Configuration > Statusline".

### Statusline Verification [CRITICAL]

**Before displaying "Statusline: Full/Minimal" in status, ALL checks must pass:**

| Check | Command | Pass Condition |
|-------|---------|----------------|
| 1. File exists | `test -f ./.claude/statusline.js && echo "exists"` | Returns "exists" |
| 2. Settings reference | `grep -q "statusline.js" ./.claude/settings.json && echo "referenced"` | Returns "referenced" |
| 3. Path correct | `jq -r '.statusLine.command' ./.claude/settings.json` | Contains `.claude/statusline.js` |
| 4. Test render | `echo '{"cwd":"'$(pwd)'","model":{"display_name":"Test"}}' \| node ./.claude/statusline.js` | Returns output without error |

**Verification flow:**
```bash
# Run via Bash tool before displaying status
STATUSLINE_FILE="./.claude/statusline.js"
SETTINGS_FILE="./.claude/settings.json"

# Check 1: File exists
if [ ! -f "$STATUSLINE_FILE" ]; then
  echo "FAIL: statusline.js not found"
  exit 1
fi

# Check 2: Settings reference exists
if ! grep -q "statusline.js" "$SETTINGS_FILE" 2>/dev/null; then
  echo "FAIL: statusline not referenced in settings.json"
  exit 1
fi

# Check 3: Path is correct (relative to project)
COMMAND=$(jq -r '.statusLine.command // empty' "$SETTINGS_FILE" 2>/dev/null)
if [[ ! "$COMMAND" =~ ".claude/statusline.js" ]]; then
  echo "FAIL: statusLine.command path incorrect"
  exit 1
fi

# Check 4: Test render
if ! echo '{"cwd":"'"$(pwd)"'","model":{"display_name":"Test"}}' | node "$STATUSLINE_FILE" >/dev/null 2>&1; then
  echo "FAIL: statusline.js render failed"
  exit 1
fi

echo "OK: Statusline verified"
```

**Status display rules:**
- All 4 checks pass → Show `Statusline: Full` or `Statusline: Minimal`
- Any check fails → Show `Statusline: Broken (run /cco-tune to fix)`
- No statusline configured → Show `Statusline: None`

**After writing statusline files, re-run verification to confirm installation.**

---

### Permission Files

**Source:** `claudecodeoptimizer/content/permissions/`

| Level | Source File | Description |
|-------|-------------|-------------|
| Safe | `permissions/safe.json` | Most restrictive - read-only auto-approved |
| Balanced | `permissions/balanced.json` | Read + lint/test auto-approved, writes require approval |
| Permissive | `permissions/permissive.json` | Most operations auto-approved, only dangerous ops blocked |

**Target:** `./.claude/settings.json` → `permissions` key

**Install Behavior:**
- ALWAYS overwrite `permissions` section in `.claude/settings.json` with fresh content from source template
- Merge with existing settings.json (preserve `env`, `statusLine` if present)
- Never skip because "permissions already configured"

**Permission Structure:**
```json
{
  "permissions": {
    "allow": [
      "# Allowed patterns - auto-approved",
      "git status *",
      "npm test"
    ],
    "deny": [
      "# Denied patterns - blocked or require approval",
      "rm -rf *",
      "git push --force *"
    ]
  }
}
```

**Permission Levels Summary:**

| Category | Safe | Balanced | Permissive |
|----------|------|----------|------------|
| Git read (status, log, diff) | Auto | Auto | Auto |
| Git write (commit, push) | Ask | Ask | Auto |
| Git dangerous (force push, reset --hard) | Deny | Deny | Deny |
| Lint/Format (check mode) | Ask | Auto | Auto |
| Lint/Format (write mode) | Ask | Ask | Auto |
| Test execution | Ask | Auto | Auto |
| Package install | Ask | Ask | Auto |
| File read (ls, cat) | Auto | Auto | Auto |
| File write (touch, mkdir) | Ask | Ask | Auto |
| File delete (rm) | Ask | Ask | Ask |
| File delete recursive (rm -rf) | Deny | Deny | Deny |
| Docker (non-privileged) | Ask | Ask | Auto |
| Docker (privileged) | Deny | Deny | Deny |
| System (sudo, chmod 777) | Deny | Deny | Deny |

### Permission Verification

After writing permission config, verify:
1. `./.claude/settings.json` contains valid `permissions` object
2. No conflicting patterns (same pattern in both allow and deny)
3. JSON syntax is valid

### Project Rules Directory Format

cco-tune generates files in `./.claude/rules/cco/` using path-specific YAML frontmatter:

**1. context.md (always loaded - no paths frontmatter):**
```markdown
# Project Context

## Strategic Context
Purpose: {purpose}
Team: {team} | Scale: {scale} | Data: {data} | Compliance: {compliance}
Stack: {stack} | Type: {type} | DB: {db} | Rollback: Git
Architecture: {pattern} | API: {style} | Deployment: {strategy}
Maturity: {maturity} | Breaking: {breaking} | Priority: {priority}
Testing: {strategy} | SLA: {level} | Real-time: {requirement}

## Guidelines
{generated based on values - see Guidelines Generation section}

## Operational
Tools: {format}, {lint}, {test}
Conventions: {detected patterns}
Applicable: {check categories}
Not Applicable: {excluded categories}

## Auto-Detected
Structure: {type} | Hooks: {status} | Coverage: {N}%
{checklist of detected features}
License: {type}
Secrets detected: {yes|no}
Outdated deps: {N}
```

**2. Category rule files (path-specific with YAML frontmatter):**
```markdown
---
paths: **/*.py
---
# Python Rules

- **Type-Hints**: Type annotations for public APIs
- **Docstrings**: Google-style for public functions
```

**Path pattern mapping (from detection):**

| Detection | Output File | Paths |
|-----------|-------------|-------|
| Python stack | `python.md` | `**/*.py` |
| TypeScript | `typescript.md` | `**/*.{ts,tsx}` |
| JavaScript | `javascript.md` | `**/*.{js,jsx}` |
| Go | `go.md` | `**/*.go` |
| Rust | `rust.md` | `**/*.rs` |
| T:CLI | `cli.md` | `**/__main__.py, **/cli/**/*` |
| T:Library | `library.md` | `**/src/**/*` |
| API:REST | `api.md` | `**/routes/**/*`, `**/api/**/*` |
| CI/CD | `operations.md` | `.github/**/*`, `.gitlab-ci.yml` |
| Testing | `testing.md` | `tests/**/*`, `**/*.test.*`, `**/*_test.*` |
| Frontend | `frontend.md` | `**/components/**/*`, `**/pages/**/*` |
| DB:* | `database.md` | `**/models/**/*`, `**/migrations/**/*` |

**CRITICAL - Granular Selection:**

Each rule in adaptive.md has an "Applicability Check". Only include rules where the check passes for this specific project.

**Example output files:**

`./.claude/rules/cco/cli.md`:
```markdown
---
paths: **/__main__.py, **/cli/**/*
---
# CLI Rules

- **Help-Examples**: --help with usage for every command
- **Exit-Codes**: 0 success, non-zero with meaning
- **Output-Modes**: Human default, --json for scripts
```

`./.claude/rules/cco/operations.md`:
```markdown
---
paths: .github/**/*
---
# Operations Rules

- **Config-as-Code**: Versioned, env-aware
- **CI-Gates**: lint + test + coverage before merge
```

**Granular Evaluation Process:**
1. For each triggered category (e.g., T:CLI), read rules from adaptive.md (in pip package)
2. For each rule, check "Applicability Check" column
3. Only include rules where check passes
4. **Transform format**: adaptive.md has 3 columns → output has list format
   - Source: `| * Rule-Name | Applicability Check | Concise description |`
   - Output: `- **Rule-Name**: Concise description` (same format as core.md, ai.md)
5. Write to appropriate `.claude/rules/cco/{category}.md` file with paths frontmatter

**Format Consistency [CRITICAL]:**
All CCO rule files use the same list format:
```markdown
- **Name**: Concise description
```
- `~/.claude/rules/cco/core.md` - list format
- `~/.claude/rules/cco/ai.md` - list format
- `./.claude/rules/cco/*.md` - list format (same format)

**Note:** AI Performance settings are NOT stored in rules - they are only in `./.claude/settings.json` where Claude Code reads them.

**IMPORTANT:** Project rules in `.claude/rules/cco/` are the foundation for ALL other CCO commands. They validate against this context and refuse to run operations outside its scope.

---

## Step 6: Report

Show before/after comparison for all changed settings:

```
╔════════════════════════════════════════════════════════════════════════════════╗
║                            CCO TUNE COMPLETE                                   ║
╠════════════════════════════════════════════════════════════════════════════════╣
║ CHANGES APPLIED (all local, no global modifications)                           ║
├────────────────┬───────────────────┬───────────────────┬───────────────────────┤
║ Setting        │ Before            │ After             │ Reason                ║
├────────────────┼───────────────────┼───────────────────┼───────────────────────┤
║ Context        │ {before|none}     │ {after}           │ {reason}              ║
║ Thinking       │ {before|none}     │ {value} tokens    │ complexity: {score}   ║
║ MCP Output     │ {before|none}     │ {value} tokens    │ files: {count}        ║
║ Caching        │ {before|none}     │ {on|off}          │ {reason}              ║
║ Statusline     │ {before|none}     │ {mode}            │ {reason}              ║
║ Permissions    │ {before|none}     │ {level} ({N})     │ {reason}              ║
╠════════════════════════════════════════════════════════════════════════════════╣
║ RULES                                                                          ║
├────────────────┬───────────────────────────────────────────────────────────────┤
║ Base           │ {BASE_TOTAL} (Universal + AI + CCO)                           ║
║ Project        │ +{PROJECT_SPECIFIC} ({triggered_subsections})                 ║
║ Total          │ {TOTAL} rules                                                 ║
╠════════════════════════════════════════════════════════════════════════════════╣
║ FILES WRITTEN                                                                  ║
├────────────────────────────────────────────────────────────────────────────────┤
║ ./.claude/rules/cco/context.md     Project strategic context (always loaded)       ║
║ ./.claude/rules/cco/{category}.md  Path-specific rules (python.md, cli.md, etc.)   ║
║ ./.claude/settings.json        env + statusLine + permissions                  ║
║ ./.claude/statusline.js        Status bar script (if statusline configured)    ║
╠════════════════════════════════════════════════════════════════════════════════╣
║ Restart Claude Code for changes to take effect                                 ║
║ Next: /cco-health to verify | /cco-audit to check                              ║
╚════════════════════════════════════════════════════════════════════════════════╝
```

**Before/After rules:**
- `{none}` - setting didn't exist before
- `{removed}` - setting was removed (After column shows "removed")
- `{unchanged}` - value is the same (skip row or show for reference)
- Only show rows for settings that were actually configured or removed in this session
- Reason column shows detection source, user choice, or "user requested removal"

**Removal display example:**
```
║ Rules          │ configured        │ removed           │ user requested    ║
║ AI Performance │ 8000 tokens       │ removed           │ user requested    ║
║ Statusline     │ Full              │ removed           │ user requested    ║
║ Permissions    │ Balanced (12)     │ removed           │ user requested    ║
```

**Mixed operations example (Remove + Configure in same run):**
```
║ Setting        │ Before            │ After             │ Reason            ║
├────────────────┼───────────────────┼───────────────────┼───────────────────┤
║ Rules          │ none              │ configured        │ detection         ║
║ AI Performance │ 8000 tokens       │ removed           │ user requested    ║
║ Statusline     │ none              │ Full              │ user selected     ║
║ Permissions    │ Balanced (12)     │ removed           │ user requested    ║
```

**Export section (if export selected):**
```
╠════════════════════════════════════════════════════════════════════════════════╣
║ EXPORTED FILES                                                                 ║
├────────────────┬───────────────────────────────────────────────────────────────┤
║ ./AGENTS.md    │ Universal + AI-Specific + Project Context + Conditional       ║
║ ./CLAUDE.export.md │ All rules including CCO-Specific                      ║
╠════════════════════════════════════════════════════════════════════════════════╣
║ EXPORT CONTENT (user selected)                                                 ║
├────────────────────────────────────────────────────────────────────────────────┤
║ ✓ Universal Rules           ✓ AI-Specific Rules                                ║
║ ✓ Project Context           ✗ Conditional Rules (not selected)             ║
╚════════════════════════════════════════════════════════════════════════════════╝
```

---

## Export Mode

Export **rules only** to portable format. Select directly from main question:
- **CLAUDE.md**: For sharing with other Claude Code projects (all categories)
- **AGENTS.md**: For other AI tools - Cursor, Windsurf, Copilot, etc. (CCO-Specific excluded)

Both can be selected together to export to both formats.

### What Can Be Exported (User Selectable)

| Selectable Content | Source | AGENTS.md | CLAUDE.md |
|--------------------|--------|-----------|-----------|
| Universal Rules | `~/.claude/rules/cco/core.md` | ✓ | ✓ |
| AI-Specific Rules | `~/.claude/rules/cco/ai.md` | ✓ | ✓ |
| Project Context | `./.claude/rules/cco/context.md` | ✓ | ✓ |
| Conditional Rules | `./.claude/rules/cco/*.md` | ✓ | ✓ |

### What Is NEVER Exported

| NOT Exported | Reason |
|--------------|--------|
| AI Performance (env) | Project-specific tuning |
| Statusline config | Local preference |
| Permission rules | Security policy varies |
| settings.json | Not portable |
| statusline.js | Not portable |

**In short:** Export = Rules & Context (user choice). Local settings are project-specific and never exported.

### Source Files [CRITICAL]

**Export reads from installed files, NOT from command specs:**

| Source | Content | Location |
|--------|---------|----------|
| Global rules | Universal + AI-Specific + CCO-Specific | `~/.claude/rules/cco/` |
| Project context | Strategic Context | `./.claude/rules/cco/context.md` |
| Project rules | Conditional Rules | `./.claude/rules/cco/*.md` |

**Prerequisites:**
- `~/.claude/rules/cco/` MUST exist with core.md, ai.md (run `cco-setup` first if missing)
- `./.claude/rules/cco/` is optional (export will include global rules only)

**Export process:**
1. Check `~/.claude/rules/cco/core.md` exists → error if missing: "Run cco-setup first"
2. Ask user what to include (multiSelect with "All" default)
3. Read selected sections from `~/.claude/rules/cco/`
4. Read selected sections from `./.claude/rules/cco/` (if exists and selected)
5. Combine based on export format and user selection
6. Write to target file

### Export Content by Format

| Category | AGENTS.md | CLAUDE.md |
|----------|-----------|-----------|
| Universal | Included | Included |
| AI-Specific | Included | Included |
| CCO-Specific | **Excluded** | Included |
| Project-Specific | Included (triggered only) | Included (triggered only) |

### AGENTS.md Export

**Source:** `~/.claude/rules/cco/` + `./.claude/rules/cco/`
**Target:** `./AGENTS.md`

**Process:**
1. Read Universal Rules from `~/.claude/rules/cco/core.md`
2. Read AI-Specific Rules from `~/.claude/rules/cco/ai.md`
3. Skip CCO-Specific Rules (not portable to other AI tools)
4. Read Project Context from `./.claude/rules/cco/context.md`
5. Read Conditional Rules from `./.claude/rules/cco/*.md` (excluding context.md)
6. Transform to prose format (remove frontmatter, simplify structure)

**Output format:**
```markdown
# Project Rules

> Exported from CCO (ClaudeCodeOptimizer)

## Project Context
{from ./.claude/rules/cco/context.md}

## Universal Rules
{from ~/.claude/rules/cco/core.md}

## AI-Specific Rules
{from ~/.claude/rules/cco/ai.md}

## Project-Specific Rules
{from ./.claude/rules/cco/*.md Conditional Rules}
```

### CLAUDE.md Export

**Source:** `~/.claude/rules/cco/` + `./.claude/rules/cco/`
**Target:** `./CLAUDE.export.md` (to avoid overwriting project's CLAUDE.md)

**Process:**
1. Read ALL rules from `~/.claude/rules/cco/` (core.md, ai.md)
2. Read all rules from `./.claude/rules/cco/` (context.md + category files)
3. Combine with CCO markers preserved
4. Write to `./CLAUDE.export.md`

For use in other Claude Code projects - copy content to target project's `./CLAUDE.md`.

---

## Rules Count Structure

Rules are organized in 4 categories. **All counts are dynamically calculated at runtime.**

### Source Files

| Category | Source (Original) | Installed Location |
|----------|-------------------|-------------------|
| Core | `content/rules/cco-core.md` | `~/.claude/rules/cco/core.md` |
| AI | `content/rules/cco-ai.md` | `~/.claude/rules/cco/ai.md` |
| Tools | `content/rules/cco-tools.md` | Embedded in commands/agents |
| Adaptive | `content/rules/cco-adaptive.md` | `./.claude/rules/cco/*.md` (project-specific) |

### Count Commands

**See [Step 1.1](#11-count-rules-first-mandatory) for the MANDATORY commands to run.**

### Count Rules

1. **Always execute commands** - Never use memorized or estimated values
2. **Use section boundaries** - `sed` extracts specific sections before counting
3. **Count list pattern** - Lines starting with `- **Name**:` are rules (Name can have hyphens)
4. **Use grep command** - `grep -cE "^- \*\*[A-Za-z][-A-Za-z0-9]*\*\*:"` counts rule lines
5. **Verify math** - `BASE_TOTAL = CORE + AI` (tools is on-demand)
6. **Display exact values** - No `~` prefix, no approximations
7. **Exclude context.md** - context.md contains project info, not rules

---

## Detection → Action Mapping

**PRINCIPLE:** Every detection triggers exactly one action type. No informational-only detections.

### Action Types

| Action Type | Target | Example |
|-------------|--------|---------|
| `→ {category} rules` | .claude/rules/cco/{category}.md | `→ CLI rules` evaluates CLI subsection |
| `→ context` | .claude/rules/context.md | Purpose, Stack, License |
| `→ tools` | .claude/rules/context.md Operational | format, lint, test commands |
| `→ guidelines` | .claude/rules/context.md Guidelines | Team-based recommendations |
| `→ env` | settings.json env section | Thinking tokens, MCP tokens |
| `→ permissions` | settings.json permissions | Based on Team/Data |
| `complexity +N` | AI Performance calculation | Bumps thinking token tier |

### Detection → Action Reference

| Detection | Confidence | Primary Action | Secondary Action |
|-----------|------------|----------------|------------------|
| **Core (ALWAYS evaluate)** |||
| Purpose | HIGH | → context | - |
| Stack: Python | HIGH | → python.md rules | → context + tools |
| Stack: TypeScript | HIGH | → typescript.md rules | → context + tools |
| Stack: JavaScript | HIGH | → javascript.md rules | → context + tools |
| Stack: Go | HIGH | → go.md rules | → context + tools |
| Stack: Rust | HIGH | → rust.md rules | → context + tools |
| Type: CLI | HIGH | → cli.md rules | - |
| Type: Library | HIGH | → library.md rules | - |
| **Scale (ALWAYS evaluate - default S:Small)** |||
| Scale | MEDIUM | → scale.md rules | → guidelines |
| **Infrastructure** |||
| CI/CD | HIGH | → operations.md rules | → tools |
| Container | HIGH | → container.md rules | - |
| K8s | HIGH | → k8s.md rules | complexity +1 |
| Serverless | HIGH | → serverless.md rules | - |
| Monorepo | HIGH | → monorepo.md rules | MCP tier bump |
| **Backend** |||
| DB | HIGH | → database.md rules | - |
| API: REST | HIGH | → api.md rules | - |
| API: GraphQL | HIGH | → api.md rules | + GraphQL rules |
| API: gRPC | HIGH | → api.md rules | + gRPC rules |
| API: WebSocket | HIGH | → realtime.md rules | - |
| Microservices | HIGH | → scale.md (Large) | complexity +2 |
| **Frontend/Apps** |||
| Frontend | HIGH | → frontend.md rules | - |
| Mobile | HIGH | → mobile.md rules | - |
| Desktop | HIGH | → desktop.md rules | - |
| **Specialized** |||
| ML/AI | HIGH | → ml-ai.md rules | complexity +1 |
| Game | HIGH | → game.md rules | - |
| i18n | HIGH | → i18n.md rules | - |
| **Quality** |||
| Test Framework | HIGH | → testing.md rules | - |
| Coverage | HIGH | → context | - |
| Linting | HIGH | → tools | - |
| Formatting | HIGH | → tools | - |
| Pre-commit | HIGH | → context (hooks) | - |
| Security Scan | HIGH | security posture | - |
| Secrets Risk | HIGH | → security.md rules | - |
| **Team/Org** |||
| Team Size | MEDIUM | → team.md rules | → guidelines |
| SLA | MEDIUM | → observability.md rules | - |
| **Context (user-configurable)** |||
| Data Sensitivity | LOW | → guidelines | → security weight |
| Compliance | LOW | → compliance hint | - |
| Maturity | MEDIUM | → guidelines | - |
| Breaking | MEDIUM | → guidelines | - |
| AI Perf | HIGH | → env | - |
| **Dependency-Based (scan manifest)** |||
| DEP:GPU | HIGH | → gpu.md rules | complexity +1 |
| DEP:Audio | HIGH | → audio.md rules | - |
| DEP:Video | HIGH | → video.md rules | - |
| DEP:Image | HIGH | → image.md rules | - |
| DEP:HeavyModel | HIGH | → heavy-model.md rules | complexity +1 |
| DEP:DataHeavy | HIGH | → data-heavy.md rules | - |
| DEP:GamePython | HIGH | → game-python.md rules | - |
| DEP:GameJS | HIGH | → game-js.md rules | - |
| DEP:GameEngine | HIGH | → game-engine.md rules | complexity +1 |
| DEP:HTTP | HIGH | → http-client.md rules | - |
| DEP:ORM | HIGH | → orm.md rules | - |
| DEP:Auth | HIGH | → auth.md rules | - |
| DEP:Payment | HIGH | → payment.md rules | - |
| DEP:Email | HIGH | → email.md rules | - |
| DEP:SMS | HIGH | → sms.md rules | - |
| DEP:Notification | HIGH | → notification.md rules | - |
| DEP:Search | HIGH | → search.md rules | - |
| DEP:Queue | HIGH | → queue.md rules | - |
| DEP:Cache | HIGH | → cache.md rules | - |
| DEP:Logging | HIGH | → logging.md rules | - |
| DEP:ObjectStore | HIGH | → object-store.md rules | - |
| DEP:PDF | HIGH | → pdf.md rules | - |
| DEP:Excel | HIGH | → excel.md rules | - |
| DEP:Crypto | HIGH | → crypto.md rules | - |
| DEP:Blockchain | HIGH | → blockchain.md rules | complexity +1 |
| DEP:ARVR | HIGH | → arvr.md rules | complexity +1 |
| DEP:IoT | HIGH | → iot.md rules | - |
| DEP:Scraping | HIGH | → scraping.md rules | - |

**Rule Selection:** For each category, evaluate every rule individually against project context. Include only rules that are relevant and actionable for this specific project.

### Key Principles

1. **Every detection has action** - No informational-only fields
2. **Granular selection** - Each trigger independently evaluated
3. **No false positives** - CI/CD does NOT trigger API or Data
4. **Stacking allowed** - Multiple triggers stack additively
5. **No duplicates** - Each rule added exactly once
6. **Confidence-aware** - LOW confidence items highlighted for review

**Dynamic calculation:** Count list pattern in rules files. Command: `grep -cE "^- \*\*\w+\*\*:" <file>`. Never use hardcoded counts.

---

## Guidelines Generation

Guidelines are generated based on user-configured values to provide context-aware recommendations.

### Team Size Guidelines

| Condition | Generated Guideline |
|-----------|---------------------|
| Team: Solo | Self-review sufficient, document for future |
| Team: Small (2-5) | Informal review, async communication |
| Team: Medium (6-15) | Formal review, CODEOWNERS required |
| Team: Large (16-50) | ADRs mandatory, cross-team sync |
| Team: Enterprise (51+) | Scaling frameworks, architecture governance |

### Scale Guidelines

| Condition | Generated Guideline |
|-----------|---------------------|
| Scale: Prototype (<100) | Simple solutions, clarity first |
| Scale: Small (100-1K) | Add basic caching, error tracking |
| Scale: Medium (1K-100K) | Horizontal scaling, monitoring |
| Scale: Large (100K-1M) | Performance critical, load testing |
| Scale: Hyperscale (1M+) | Distributed systems, global CDN |

### Data Sensitivity Guidelines

| Condition | Generated Guideline |
|-----------|---------------------|
| Data: Public | Basic validation sufficient |
| Data: Internal | Auth required, access logging |
| Data: Confidential | Encryption in transit/rest |
| Data: PII | Minimize retention, audit logs |
| Data: Regulated | Full compliance, external audit |

### Maturity Guidelines

| Condition | Generated Guideline |
|-----------|---------------------|
| Maturity: Prototype | Move fast, skip docs |
| Maturity: Greenfield | Aggressive refactors OK |
| Maturity: Active | Balanced refactors |
| Maturity: Stable | Conservative, stability first |
| Maturity: Legacy | Wrap don't modify |
| Maturity: Sunset | Document for migration |

### Breaking Changes Guidelines

| Condition | Generated Guideline |
|-----------|---------------------|
| Breaking: Allowed | Clean API over compatibility |
| Breaking: Minimize | Deprecate first, migration path |
| Breaking: Never | Adapters required |

### Priority Guidelines

| Condition | Generated Guideline |
|-----------|---------------------|
| Priority: Speed | MVP mindset, ship fast |
| Priority: Balanced | Standard practices |
| Priority: Quality | Thorough, no shortcuts |
| Priority: Security | Threat modeling first |
| Priority: Cost | Efficiency focus |

### SLA Guidelines

| Condition | Generated Guideline |
|-----------|---------------------|
| SLA: None | Best-effort availability |
| SLA: Standard (99%) | Basic monitoring, alerts |
| SLA: High (99.9%) | Redundancy required |
| SLA: Critical (99.99%) | HA architecture, DR plan |
| SLA: Mission-Critical | Global redundancy, chaos testing |

---

## Rules

1. **All questions at the start** - no mid-process interruptions
2. **Local files only** - AI Performance, statusline, permissions ALL in `./.claude/settings.json`, project rules in `./.claude/rules/cco/`, NEVER touch `~/.claude/`
3. **Dynamic counts** - ALWAYS run Step 1.1 commands before displaying any count. Never estimate or use hardcoded values
4. **Show affected rules** - when editing, show what rules change
5. **Path-specific rules** - Category rules use YAML frontmatter with `paths:` for conditional loading
6. **ALWAYS overwrite CCO content** - All CCO-managed content is ALWAYS overwritten with fresh source:
   - `.claude/statusline.js` → overwrite entirely (check for "CCO Statusline" marker)
   - `.claude/settings.json` → overwrite `env`, `statusLine`, `permissions` sections
   - `.claude/settings.json` → remove legacy keys: `_cco_managed`, `_cco_version`, `_cco_installed`, `cco_config`, `ccoSettings`
   - `.claude/rules/cco/*.md` → overwrite category files with fresh detection results
   - Never skip because "file exists" or "content unchanged" - always write fresh
7. **Granular rule selection** - each subsection is independently evaluated, not atomic categories
8. **No duplicate rules** - each rule is added exactly once; deduplicate before writing to rules files
9. **Never modify global** - cco-tune may READ `~/.claude/rules/cco/` for counting, but NEVER write/modify any file in `~/.claude/`
10. **Clean project rules on update** - When updating, remove all existing `.claude/rules/cco/*.md` files before writing new ones
11. **Question Labels** - Follow CCO "Question Formatting" rule (labels, precedence, ordering)
12. **Review Sequence** - Detection results → Configuration Summary box → Approval question
13. **String env values** - All `env` values in settings.json must be strings per official Claude Code docs
14. **Export reads installed files** - Export reads from `~/.claude/rules/cco/` and `./.claude/rules/cco/`, NOT from command specs
15. **Export content is user-selectable** - User chooses which sections to include (Universal, AI-Specific, CCO-Specific, Project Context, Conditional)
16. **Export never includes settings** - AI Performance, Statusline, Permissions are NEVER exported (project-specific, not portable)
17. **CLAUDE.md cleanup only** - Remove ALL CCO marker blocks from `./CLAUDE.md`, never add content
18. **Read adaptive.md for rules** - ALWAYS read `cco-adaptive.md` from package to select project rules

---

## Behavior Rules

### User Input [CRITICAL]

- **AskUserQuestion**: ALL user decisions MUST use this tool
- **Separator**: Use semicolon (`;`) to separate options
- **Prohibited**: Never use plain text questions ("Would you like...", "Should I...")

### Question Formatting [STRICT]

| Rule | Description |
|------|-------------|
| Separate-Categories | Present different categories in SEPARATE batches |
| One-Label | Each option has exactly ONE label |
| Current | `[current]` - matches existing config (priority 1) |
| Detected | `[detected]` - auto-detected, not in config (priority 2) |
| Recommended | `(Recommended)` - best practice, max 1/question (priority 3) |
| Precedence | If detected AND current → show `[current]` only |

### Option Ordering

- **Numeric**: Ascending (60 → 70 → 80 → 90)
- **Severity**: Safest → riskiest
- **Scope**: Narrowest → widest

### Pagination

- **Max-Questions**: 4 per AskUserQuestion call
- **Max-Options**: 4 per question
- **Overflow**: Use multiple sequential calls

### Task Tracking

- **Create**: TODO list with configuration phases
- **Status**: pending → in_progress → completed
- **Accounting**: configured + skipped = total
