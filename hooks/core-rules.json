{"hookSpecificOutput": {"hookEventName": "SessionStart", "additionalContext": "# Foundation Rules\n*Core principles for all software projects - forms the base context*\n\n## Design Principles\n\n- **SSOT**: Single source of truth for every piece of data/logic\n- **DRY**: Extract common patterns, avoid repetition\n- **YAGNI**: Add only requested features + robustness (validation, edge cases, error handling) - robustness is required, features are not\n- **KISS**: Simplest solution that works correctly for all valid inputs\n- **3-Question-Guard**: Before adding code/feature, ask: (1) Does absence break something? (2) Does absence confuse users? (3) Is adding worth complexity cost? All NO = don't add\n- **Separation-of-Concerns**: Distinct responsibilities per module\n- **Composition**: Prefer composition over inheritance\n- **Idempotent**: Same operation, same result, safe to retry\n- **Least-Astonishment**: Behavior matches user expectations\n- **Defensive-Default**: Assume bad input, validate anyway. Cost of validation << cost of bug\n- **Depend-Abstract**: High-level modules depend on abstractions, not implementations\n\n## Code Quality\n\n- **Fail-Fast**: Immediate visible failure, propagate errors explicitly\n- **Used-Only**: Keep only called functions and used imports\n- **Type-Safe**: Full type annotations on all public APIs. Prefer stricter types (Literal, enums over strings)\n- **Immutable**: Prefer immutable, mutate only when necessary\n- **Clean**: Meaningful names, single responsibility\n- **Explicit**: Use named constants, clear intent\n- **Robust**: Handle all valid input variations (whitespace, case, empty, None, boundary values)\n- **Async-Await**: Use async/await for I/O operations, keep async context non-blocking\n- **Graceful-Shutdown**: Handle termination signals, drain connections before exit\n\n### Complexity Thresholds\n\n| Metric | Good | Review | Refactor |\n|--------|------|--------|----------|\n| Cyclomatic Complexity | 1-10 | 11-15 | 16+ |\n| Cognitive Complexity | < 15 | 15-20 | 21+ |\n| Method Lines | < 50 | 50-100 | 100+ |\n| File Lines | < 500 | 500-1000 | 1000+ |\n| Nesting Depth | <= 3 | 4 | 5+ |\n| Parameters | <= 4 | 5-7 | 8+ |\n\n## File & Resource\n\n- **Minimal-Touch**: Only files required for task\n- **Request-First**: Create files only when explicitly requested\n- **Paths**: Forward slash, relative, quote spaces\n- **Cleanup**: Temp files, handles, connections\n- **Skip**: VCS (.git, .svn), deps (node_modules, vendor, venv), build (dist, out, target), IDE (.idea, .vscode), generated (*.min.*, @generated)\n\n## Efficiency\n\n- **Parallel-Independent**: Run unrelated operations simultaneously\n- **Sequential-Dependent**: Chain dependent operations\n- **Lazy-Evaluation**: Defer work until needed\n- **Cache-Reuse**: Cache results, reuse computations\n- **Batch-Operations**: Group similar operations\n\n## Robustness\n\n- **Validate-Boundaries**: All public APIs MUST validate input at entry point\n- **Type-Check-Explicit**: Verify types explicitly, don't rely on implicit coercion\n- **Range-Bounds**: Numeric inputs MUST have min/max limits defined\n- **String-Length-Limit**: String inputs MUST have max length limit\n- **Collection-Size-Limit**: Array/list inputs MUST have max items limit\n- **Explicit-Null-Check**: Check for None/null explicitly before use\n- **Optional-Defaults**: Provide sensible defaults for optional parameters\n- **Early-Return-Null**: Return early when null check fails\n- **Graceful-Degradation**: System continues with reduced functionality on partial failure\n- **Retry-Transient**: Retry transient errors (network, timeout) with exponential backoff\n- **Circuit-Breaker**: Implement circuit breaker for external service calls\n- **Timeout-Required**: ALL external calls MUST have explicit timeout\n- **Close-Always**: Resources MUST be closed in finally block or using with/using statement\n- **Pool-Connections**: Use connection pools for database/http connections\n\n## Error Handling\n\n- **Catch-Context**: Log context, recover or propagate\n- **Log-All**: Log all exceptions with context before handling\n- **User-Actionable**: Clarity + next steps for users\n- **Logs-Technical**: Technical details only in logs\n- **Rollback-State**: Consistent state on failure\n\n## Documentation\n\n- **README**: Description, setup, usage\n- **CHANGELOG**: Versions with breaking changes\n- **Comments-Why**: Explain why, not what\n- **Examples**: Working, common use cases\n\n## Refactoring Safety\n\n- **Delete-Impact**: Before deleting function/class/file, identify ALL callers and dependents\n- **Rename-Cascade**: Rename operation = find refs + update ALL + verify builds\n- **Move-Imports**: When moving code between files, update all import statements\n- **Signature-Propagate**: Changing function signature requires updating all call sites\n- **Type-Cascade**: Type changes must propagate to all consumers\n\n## UX/DX\n\n- **Minimum-Friction**: Fewest steps to goal\n- **Maximum-Clarity**: Unambiguous output\n- **Predictable**: Consistent behavior\n- **Fast-Feedback**: Progress indicators, incremental results\n- **Step-Progress**: Multi-step operations show \"Step 2/5: Building...\"\n- **Summary-Final**: End with summary: \"Changed 3 files, added 2 tests\"\n- **Impact-Explain**: Show why: \"This reduces bundle size by 15%\"\n- **Error-Actionable**: Errors include file:line AND suggested fix\n\n## Team Collaboration\n\n- **PR-Review**: Async code review on all changes\n- **ADR**: Architecture Decision Records for significant decisions\n- **CODEOWNERS**: Clear ownership via CODEOWNERS file (6+ team)\n- **Branch-Protection**: Require reviews before merge (6+ team)\n\n# Safety Rules\n*Non-negotiable standards - violations require immediate fix*\n\n## Non-Negotiable Standards [CRITICAL]\n\nThese are NEVER acceptable, regardless of context. Trigger CRITICAL severity automatically:\n\n| # | Standard | Violation | Required Action |\n|---|----------|-----------|-----------------|\n| 1 | **No Silent Failures** | Error without logging AND user feedback | Add logging + user message |\n| 2 | **No Broad Catches** | `except:` or `catch (e)` without specific types | Catch specific exception types |\n| 3 | **No Hidden Fallbacks** | Fallback behavior without explicit justification | Document or remove fallback |\n| 4 | **No Hardcoded Secrets** | API keys, passwords, tokens in source | Move to env vars or vault |\n| 5 | **No Unvalidated Input** | External data used without sanitization | Add input validation |\n| 6 | **No Empty Handlers** | Empty catch/except blocks | Add handling or propagate |\n| 7 | **No Mocks in Production** | Test doubles in non-test code | Remove or guard with test flag |\n\n**Enforcement:** Finding any of these = CRITICAL severity, confidence 100, must fix before proceeding.\n\n## Security Priority\n\n- **Security-Priority**: Security rules are non-negotiable. Prioritize security over convenience and speed\n- **Block-On-Violation**: Security violation = STOP. Fix before continuing. Warn user explicitly\n- **Defense-Assume**: When uncertain about security impact, assume the worst and protect accordingly\n\n## Rule Enforcement\n\n- **Apply-All-Rules**: Every change MUST comply with ALL rules currently in context (global + project-specific)\n- **Verify-After-Change**: After EVERY code change, verify compliance before proceeding\n- **Fix-Immediately**: Violation detected = stop, fix, re-verify. Fix now, not later (\"cleanup later\" is not acceptable)\n- **Full-Compliance**: Fix all violations before proceeding. 100% compliance required, not \"mostly compliant\"\n\n## Base Security (OWASP A01-A10)\n\n### Access Control (A01)\n- **Access-Control-Enforce**: Deny by default, require explicit grants. Verify permissions server-side on every request\n- **Least-Privilege**: Minimum necessary access for users and services\n- **SSRF-Prevent**: Validate URLs, block internal IPs (10.x, 172.16.x, 192.168.x, 127.x), use allowlists\n\n### Configuration Security (A02)\n- **Safe-Defaults**: Production defaults must be secure: debug off, verbose errors off, restrictive CORS\n- **Secrets**: Env vars or vault only, never in code or version control\n- **Error-Disclosure**: Show generic error messages to users. Keep stack traces server-side\n\n### Supply Chain Security (A03)\n- **Lockfile-Required**: Use dependency lockfile, pin versions, no floating ranges\n- **Deps-Audit**: Review dependencies before adding, prefer well-maintained packages\n\n### Input & Output (A04, A05)\n- **Input-Boundary**: Validate ALL user input at system entry points. Use schema validation\n- **Output-Encode**: Encode output based on context (HTML, URL, JS, CSS)\n- **Deserialize-Safe**: Deserialize only trusted data using safe formats (JSON). Never pickle/yaml.load/eval\n\n### Authentication (A07)\n- **Session-Security**: Secure + HttpOnly + SameSite=Lax/Strict cookies, token TTL with refresh strategy\n- **Password-Security**: Store passwords with bcrypt/argon2/scrypt using appropriate cost factor\n- **Auth-Identical-Errors**: Use identical auth failure messages (prevents user enumeration)\n\n### Logging & Monitoring (A09)\n- **Audit-Log**: Immutable logging for security-critical actions. Include who, what, when, from-where\n- **Redact-Sensitive**: Redact/mask secrets, tokens, credentials, PII in all output\n\n### Error Handling (A10)\n- **Error-Graceful**: Handle exceptional conditions gracefully, fail secure (deny access on error)\n- **Error-No-Leak**: Never expose internal state, paths, or stack traces to users\n- **Fail-Closed**: On security-related errors, default to deny access\n\n### Data Protection\n- **Data-Minimization**: Collect and store only necessary data. Each field requires justification\n- **Encrypt-Transit**: TLS 1.2+ for all network communication\n- **Encrypt-Rest**: AES-256-GCM for sensitive data at rest\n- **Timeout-Required**: All external calls must have explicit timeout\n\n# Workflow Rules\n*AI execution patterns and best practices*\n\n## Execution Order [CRITICAL]\n\n- **Read-First**: Read and comprehend files completely before proposing any edits\n- **Investigation-Block**: BLOCK any edit operation until target file has been read in current session. No read = no edit\n- **Plan-Before-Act**: Understand full scope before any action\n- **Incremental**: Complete one step fully before starting next\n- **Verify**: Confirm changes match stated intent\n\n## Context Awareness [CRITICAL]\n\n- **Complete-Tasks**: Never stop a task early due to perceived context limits. Context windows auto-compact via summarization - continue until task is fully complete\n- **No-Self-Limiting**: Do not artificially truncate responses or skip steps. If the task requires 50 files, process all 50 files\n- **Checkpoint-Long-Tasks**: For tasks >20 steps, provide periodic progress summaries but continue execution\n- **Request-Continuation**: If you genuinely reach a limit, explicitly state \"Task incomplete, {n} items remaining\" so user can request continuation\n- **Avoid-Premature-Optimization**: Don't skip analysis \"to save tokens\" - thoroughness > brevity for correctness-critical tasks\n\n## Agent Delegation [CRITICAL]\n\nCCO agents OUTPERFORM default Claude Code tools for specific tasks. Use them.\n\n### Quick Decision Tree\n\n```\nNeed information?\n|-- Single URL/fact -> WebSearch/WebFetch\n+-- 3+ sources, CVE, comparison -> cco-agent-research\n\nNeed analysis?\n|-- Find file/pattern -> Glob/Grep/Read\n+-- Structured scan, metrics, audit -> cco-agent-analyze\n\nNeed changes?\n|-- Single file edit -> Edit/Write\n+-- 3+ files, verification needed -> cco-agent-apply\n```\n\n### cco-agent-research\n**TRIGGERS:** \"research\", \"compare\", \"which library\", \"best practices\", \"CVE\", \"vulnerability\", \"breaking changes\", \"migration\"\n\n| Use CCO Agent | Use Default Instead |\n|---------------|---------------------|\n| Need 3+ sources | Single known URL |\n| CVE/security research | Quick fact check |\n| Library comparison | Official docs lookup |\n| Conflicting info online | Simple API reference |\n\n### cco-agent-analyze\n**TRIGGERS:** \"analyze\", \"scan\", \"audit\", \"find issues\", \"code review\", \"quality check\", \"security scan\", \"metrics\"\n\n| Use CCO Agent | Use Default Instead |\n|---------------|---------------------|\n| Security/quality audit | Find file -> Glob |\n| Metrics (coupling, complexity) | Search pattern -> Grep |\n| Multi-scope scan | Read file -> Read |\n| Platform-aware analysis | Simple explore -> Explore |\n\n### cco-agent-apply\n**TRIGGERS:** \"apply fixes\", \"fix all\", \"batch edit\", \"generate config\", \"export rules\"\n\n| Use CCO Agent | Use Default Instead |\n|---------------|---------------------|\n| Apply 3+ fixes | Single edit -> Edit |\n| Post-change verification | Simple write -> Write |\n| Cascade error handling | One-off change -> Edit |\n| Track applied/failed | Quick fix -> Edit |\n\n## Decision Making\n\n- **Challenge**: Question solutions that seem too perfect\n- **Ask**: When uncertain, clarify before proceeding\n- **Confidence**: State uncertainty level for non-obvious conclusions\n- **Read-To-Know**: Read file contents before referencing them\n- **Confirm-Intent**: Confirm user intent before making assumptions\n- **Verify-Existence**: Verify APIs, methods, parameters, file contents exist before use\n- **Security-Evidence**: Security claims require code/config evidence. No evidence = state \"unverified\"\n- **Severity-Conservative**: When uncertain between severity levels, choose lower\n\n### Severity Criteria\n\n| Severity | Criteria | Examples |\n|----------|----------|----------|\n| CRITICAL | Security breach, data loss, system crash | SQL injection, unencrypted secrets, infinite loop |\n| HIGH | Broken functionality, blocking issue, principle violation | Missing validation, type error, API mismatch |\n| MEDIUM | Suboptimal but functional, minor bug | Code smell, missing edge case, unclear naming |\n| LOW | Style, cosmetic, nice-to-have | Formatting, minor refactor opportunity |\n\n## Reasoning Strategies\n\n### Step-Back Prompting (Complex Tasks)\n\n| Task Type | Step-Back Question |\n|-----------|-------------------|\n| Refactoring | \"What is the architectural pattern here?\" |\n| Bug fix | \"What is the expected behavior of this system?\" |\n| Security audit | \"What are the trust boundaries in this codebase?\" |\n| Performance | \"What are the critical paths in this flow?\" |\n\n### Chain of Thought (Critical Decisions)\n\nFor CRITICAL-HIGH severity decisions:\n1. Identify: What exactly is the issue?\n2. Impact: Who/what is affected?\n3. Evidence: What confirms this assessment?\n4. Severity: Based on evidence, what's the appropriate level?\n\n## Efficiency Patterns\n\n- **Parallel-Tool-Batching**: Combine independent tool calls in single message for parallel execution\n- **Subagent-Delegation**: Use specialized agents for their defined purposes\n- **Tool-Over-Bash**: Prefer specialized tools (Read, Edit, Glob) over bash commands for file operations\n- **Speculative-Search**: Fire multiple parallel searches with different patterns rather than sequential refinement\n- **Background-Long**: Long-running commands -> background with `run_in_background: true`, continue working\n\n## Output Standards\n\n### Severity Levels (SSOT)\n\n| Internal | Display | Description |\n|----------|---------|-------------|\n| P0 | CRITICAL | Data loss, security breach, crash |\n| P1 | HIGH | Broken functionality, blocking issue |\n| P2 | MEDIUM | Errors, incorrect behavior |\n| P3 | LOW | Style, cosmetic, minor issues |\n\n### Status Values\n\n| Value | Meaning | Threshold |\n|-------|---------|-----------|\n| OK | All passed | Score >= 80 or no failures |\n| WARN | Issues found | Score 60-79 or some failed |\n| FAIL | Critical issues | Score 40-59 or failures present |\n| CRITICAL | Immediate action | Score < 40 |\n\n### Accounting Invariant\n\n`applied + failed = total` (AI has no option to decline - only applied or failed with technical reason)\n\n### Format Standards\n\n- **Error-Format**: `[SEVERITY] {What} in {file}:{line}`\n- **Placeholder-Format**: Use `{placeholder}` for variables, `{opt1|opt2}` for enums, `{n}` for numbers\n\n## Status Updates\n\n- **Announce-Before**: State action before starting\n- **Progress-Track**: Starting > In progress > Completed\n- **Transitions**: Clear phase signals\n- **Visible-State**: User always knows current state\n\n# Document Keeper - Proactive Rules\n*Automatic decision capture and context maintenance*\n\n## Proactive Detection [ACTIVE]\n\nDuring conversations, actively monitor for documentable items and offer to capture them.\n\n### Decision Detection\n\n**Trigger phrases** (any language):\n- Technology/tool selection: choosing X, will use X, going with X, decided on X\n- Comparisons with choice: X over Y, X instead of Y, X rather than Y\n- Architecture choices: pattern selections, structural decisions\n- Trade-off resolutions: despite X we'll Y, accepting X for Y\n\n**When detected, respond:**\n```\nüìù Decision detected: \"{brief_summary}\"\n   Category: {architecture|technology|process|design}\n   \n   Add to decision log? [Yes] [Yes + Details] [Skip]\n```\n\n### Constraint Detection\n\n**Trigger phrases** (any language):\n- Hard requirements: must, required, always, never, mandatory\n- Performance targets: under Xms, at least X, maximum X\n- Compliance: GDPR, HIPAA, SOC2, PCI, security requirement\n- Business rules: policy, rule, constraint, invariant\n\n**When detected, respond:**\n```\nüìå Constraint identified: \"{brief_summary}\"\n   Type: {hard|soft|technical}\n   \n   Add to constraints? [Yes] [Skip]\n```\n\n### Context Change Detection\n\n**Triggers:**\n- New component/module discussed or created\n- Architecture pattern established\n- Integration point identified\n- Scope boundary defined or changed\n- Major refactoring completed\n\n**When detected, respond:**\n```\nüìä Context update: {category}\n   {brief_description}\n   \n   Update project context? [Yes] [Skip] [Later]\n```\n\n## Capture Protocol\n\n1. **Detect**: Recognize decision/constraint/context in conversation\n2. **Summarize**: Extract key information concisely\n3. **Confirm**: Ask user before saving (never auto-save)\n4. **Record**: Append to appropriate .doc-keeper/ file\n5. **Acknowledge**: Confirm what was saved\n\n## Storage Locations\n\n| Item Type | File | Format |\n|-----------|------|--------|\n| Decisions | `.doc-keeper/decisions.md` | ADR-lite format |\n| Constraints | `.doc-keeper/constraints.md` | Table format |\n| Context | `.doc-keeper/context.md` | Summary markdown |\n\n## Non-Intrusive Mode\n\n- Only interrupt for HIGH-impact items (architecture, security, major tech choice)\n- Batch MEDIUM items for end-of-session summary\n- Skip LOW items unless explicitly requested\n- If user says \"stop asking\" or \"don't capture\", disable for session\n\n## Session Summary\n\nAt session end or on `/compact`, offer summary:\n```\nüìã Session Summary\n\nDetected but not saved:\n- {n} decisions\n- {n} constraints\n- {n} context updates\n\nCapture these now? [Yes] [Review Each] [Skip]\n```\n\n# Auto-Setup Rule\n*Automatic project configuration on session start*\n\n## Session Start Check [CRITICAL]\n\nOn EVERY new session, check if CCO is configured:\n\n1. **Check**: Does auto-loaded context contain `cco: true` marker?\n   - Context is auto-loaded from `.claude/rules/` into RAM\n   - Check RAM, not disk - faster and already available\n2. **If NO**: Two-step auto-setup:\n   - **Step 1**: cco-agent-analyze scope=config (questions + detection in parallel)\n   - **Step 2**: cco-agent-apply scope=config (write files using analyze output)\n3. **Agent offers** (in analyze step):\n   ```\n   üîß CCO is not configured for this project.\n\n   [Auto-setup] Detect stack and create rules automatically\n   [Interactive] Ask me questions to customize setup\n   [Skip] Don't configure CCO for this project\n   ```\n\n**Architecture**: Questions asked while detection runs in background (parallel).\n\n## Context Injection [CRITICAL]\n\nAfter auto-setup completes, cco-agent-apply MUST output the generated context content so Claude can use it immediately in the current session (without restart). Future sessions will auto-load from `.claude/rules/`."}}