{"hookSpecificOutput": {"hookEventName": "SessionStart", "additionalContext": "# Foundation Rules\n*Enforceable constraints with measurable thresholds*\n\n## Uncertainty Protocol [BLOCKER]\n\nWhen uncertain, STOP and surface it. Surface uncertainty explicitly.\n\n**Required actions:**\n- **Stop-When-Unclear**: If task is ambiguous \u2192 ask before proceeding\n- **Signal-Confidence**: State confidence level: \"~90% sure\", \"uncertain about X\", \"assuming Y\"\n\n```\n\u2713 \"Before I proceed: [specific thing] is unclear.\"\n\u2713 \"I'm ~80% confident. Uncertainty: [what].\"\n\u2717 Silently picking one interpretation\n\u2717 Proceeding despite confusion\n```\n\n## Complexity Limits [BLOCKER]\n\nCode exceeding these limits = STOP and refactor first.\n\n| Metric | Limit | Action if exceeded |\n|--------|-------|-------------------|\n| Cyclomatic Complexity | \u2264 15 | Split function |\n| Method Lines | \u2264 50 | Extract methods |\n| File Lines | \u2264 500 | Split file |\n| Nesting Depth | \u2264 3 | Flatten logic |\n| Parameters | \u2264 4 | Use object/config |\n\n## File Creation [BLOCKER]\n\n**BLOCK**: Creating new files without explicit user request.\n\n```\nUser: \"Add validation to user.py\" \u2192 Edit user.py only\nUser: \"Create a utils module\" \u2192 OK to create file\n```\n\nDirectories to skip: `.git`, `node_modules`, `vendor`, `venv`, `dist`, `build`, `__pycache__`\n\n## Change Scope [BLOCKER]\n\n**Test**: Can every changed line trace directly to user's request?\n\n- NO \u2192 Revert that change\n- If you notice unrelated issues \u2192 mention, don't fix\n\n```\n\u2713 User asked for X \u2192 only X changed\n\u2717 User asked for X \u2192 X + \"improvements\" to nearby code\n```\n\n## Code Volume [CHECK]\n\nBefore completing, verify:\n\n- [ ] No abstractions for single-use code\n- [ ] No error handling for impossible scenarios\n- [ ] If 100+ lines written \u2192 could it be 50? Rewrite if yes\n\n**Ratio check**: If implementation > 4x the minimal solution, simplify.\n\n## Success Criteria [CHECK]\n\nBefore starting multi-step tasks:\n\n```\nGoal: [one sentence]\nSteps:\n1. [action] \u2192 verify: [how to check]\n2. [action] \u2192 verify: [how to check]\nDone when: [measurable outcome]\n```\n\n**Every 5 steps**: \"Original goal: [X]. Still on track?\"\n\n## Validation Boundaries [CHECK]\n\nPublic APIs MUST have:\n\n| Input Type | Required Validation |\n|------------|---------------------|\n| Numbers | min/max bounds |\n| Strings | max length |\n| Arrays | max items |\n| External calls | timeout value |\n| Resources | cleanup in finally/with/using |\n\n## Refactoring Safety [CHECK]\n\nBefore modifying shared code:\n\n- [ ] **Delete**: Found ALL callers (grep/find-refs)\n- [ ] **Rename**: Will update ALL references\n- [ ] **Move**: Will update ALL imports\n- [ ] **Signature**: Will update ALL call sites\n\n## Output Format\n\nProgress: `\"Step 2/5: [action]...\"`\nSummary: `\"Changed 3 files, added 2 tests\"`\nErrors: `\"[SEVERITY] {what} in {file}:{line}\"`\n\n# Safety Rules\n*BLOCKER violations - must fix before proceeding*\n\n## Security Violations [BLOCKER]\n\nFinding ANY = STOP immediately. Fix before continuing.\n\n| # | Pattern | Required Fix |\n|---|---------|--------------|\n| 1 | API keys, passwords, tokens in source | Move to env vars |\n| 2 | `except:` / `catch (e)` without specific types | Catch specific exceptions |\n| 3 | Empty catch/except blocks | Add handling or propagate |\n| 4 | External data used without sanitization | Add input validation |\n| 5 | `eval()`, `pickle.load()`, `yaml.load()` | Use safe alternatives |\n\n## Security Lookup [CHECK]\n\n| Category | Safe | Unsafe |\n|----------|------|--------|\n| Deserialize | `json.loads()` | `pickle.load()`, `eval()`, `yaml.load()` |\n| Passwords | bcrypt, argon2, scrypt | MD5, SHA1, plaintext |\n| Transit | TLS 1.2+ | HTTP, TLS 1.0/1.1 |\n| Encryption | AES-256-GCM | DES, 3DES, ECB mode |\n| Internal IPs | Block all | `10.x`, `172.16.x`, `192.168.x`, `127.x`, `::1` |\n\n## Enforcement\n\n```\nViolation detected?\n\u251c\u2500\u2500 YES \u2192 STOP. Fix. Verify fix. Then continue.\n\u2514\u2500\u2500 NO \u2192 Proceed.\n```\n\n100% compliance required. \"Mostly secure\" = not secure.\n\n# Workflow Rules\n*Execution patterns and enforcement*\n\n## Read-Before-Edit [BLOCKER]\n\n**BLOCK**: Any edit to a file not yet read in this session.\n\n```\nEdit request?\n\u251c\u2500\u2500 File read? \u2192 OK to edit\n\u2514\u2500\u2500 Not read? \u2192 Read first, then edit\n```\n\nBefore calling any function/API, verify it exists with expected signature.\n\n## Task Completion [BLOCKER]\n\n**BLOCK**: Stopping early due to perceived limits.\n\n- Task needs 50 files? Process all 50.\n- Context getting long? Continue anyway.\n- Format: `\"Task incomplete, {n} items remaining\"` (if must pause)\n\n**Checkpoints**: Every 20 steps, brief progress summary. Every 5 steps, verify goal alignment.\n\n## Severity Levels [CHECK]\n\n| Level | Criteria | Examples |\n|-------|----------|----------|\n| CRITICAL | Security, data loss, crash | SQL injection, secrets exposed |\n| HIGH | Broken functionality | Missing validation, API mismatch |\n| MEDIUM | Suboptimal but works | Code smell, missing edge case |\n| LOW | Style only | Formatting, naming |\n\n**When uncertain \u2192 choose lower severity.**\n\n## Reasoning [CHECK]\n\n### For CRITICAL/HIGH findings:\n\n1. **Identify**: What exactly is the issue?\n2. **Evidence**: What confirms this?\n3. **Counter-check**: Could this be intentional? If uncertain \u2192 downgrade\n\n### For complex logic:\n\n- Pick 2-3 inputs (normal, edge, error)\n- Trace execution mentally\n- If unclear: `\"Logic uncertain at [point]\"`\n\n## Agent Delegation [CHECK]\n\n```\nInformation needed?\n\u251c\u2500\u2500 Single fact \u2192 WebSearch/WebFetch\n\u2514\u2500\u2500 3+ sources \u2192 cco-agent-research\n\nAnalysis needed?\n\u251c\u2500\u2500 Find file/pattern \u2192 Glob/Grep/Read\n\u2514\u2500\u2500 Structured audit \u2192 cco-agent-analyze\n\nChanges needed?\n\u251c\u2500\u2500 1-2 files \u2192 Edit/Write\n\u2514\u2500\u2500 3+ files \u2192 cco-agent-apply\n```\n\n## Efficiency\n\n- **Parallel calls**: Independent tool calls in single message\n- **Background Bash**: Long Bash commands \u2192 `run_in_background: true`, collect via `TaskOutput` before any output\n- **Parallel agents**: Multiple Task calls in single message (Task does NOT support `run_in_background`)\n- **Collection rule**: All background Bash results must be collected via TaskOutput before report/summary output\n\n## No Deferrals [BLOCKER - Auto Mode]\n\nWhen `--auto` active, AI MUST attempt every fix.\n\n> `needs_approval` is not a deferral \u2014 it requires user consent for architectural decisions (API changes, file deletion, dependency changes). Technically solvable fixes are never deferred.\n\n**Forbidden reasons:**\n| Never Say | Do Instead |\n|-----------|------------|\n| \"Too complex\" | Fix it |\n| \"Needs refactoring\" | Do the refactor |\n| \"Might break something\" | Fix it, user reviews via git diff |\n| \"Consider later\" | Do it NOW |\n\n**Valid failures (technical only):**\n- File not found\n- Parse error\n- Permission denied\n\n## Accounting [BLOCKER]\n\n```\napplied + failed + needs_approval = total\n```\n\nNo \"declined\" category. Every finding = `applied`, `failed` (technical reason), or `needs_approval` (architectural reason).\n\n## Model Strategy\n\n**Policy:** Opus + Haiku only (no Sonnet)\n\n| Task | Model | Reason |\n|------|-------|--------|\n| Analysis (parallel scopes) | Haiku | Fast, cost-effective scanning |\n| Apply fixes | Opus | 50-75% fewer tool errors |\n| Score calculation | Haiku | Simple aggregation |\n| Research (search) | Haiku | Cost-effective |\n| Research (synthesis) | Opus | Conflict resolution |\n\n## Anti-Overengineering Guard\n\nBefore flagging ANY finding:\n1. Does this actually break something or pose a risk?\n2. Does this cause real problems for developers/users?\n3. Is fixing it worth the effort and side effects?\n\n**All NO \u2192 not a finding.**\n\n## Output Standards\n\n| Display | Meaning |\n|---------|---------|\n| OK | Score \u2265 80 |\n| WARN | Score 60-79 |\n| FAIL | Score < 60 |\n\nError format: `[SEVERITY] {what} in {file}:{line}`\n\n# Tool Rules\n*Reusable execution patterns for commands*\n\n## Profile Validation [BLOCKER]\n\nCommands requiring project profile MUST validate before execution:\n\n1. Delegate to profile/setup command with `--preview`\n2. Handle: skipped \u2192 exit with guidance, error \u2192 exit with reason, success \u2192 continue\n3. Profile is auto-loaded via rules mechanism \u2014 no manual file read needed\n\n## Mode Detection [STANDARD]\n\nCommands supporting `--auto` MUST implement:\n\n| Mode | Behavior |\n|------|----------|\n| `--auto` | All scopes, all severities, no questions, minimal output |\n| `--preview` | Analyze only, no changes |\n| Interactive | Questions \u2192 Analysis \u2192 Plan \u2192 Apply \u2192 Summary |\n\nAuto mode config: full scope, full fix, no approval needed, single-line output.\n\n## Execution Flow [STANDARD]\n\nAll analysis commands follow: Setup \u2192 Analyze \u2192 Gate \u2192 [Plan] \u2192 Apply \u2192 Summary\n\n| Phase | Required | Notes |\n|-------|----------|-------|\n| Setup | Config + scope selection | Skip questions in --auto |\n| Analyze | Parallel agent calls | Group related scopes |\n| Gate | Validate findings structure | Fail on analysis error |\n| Plan | MANDATORY if findings > 0 | Display BEFORE asking user |\n| Apply | Synchronous agent call | Retry on failure |\n| Summary | Accounting table | Single line in --auto |\n\n## Plan Review [MANDATORY]\n\nWhen findings > 0 and not --auto:\n\n1. Generate fix plan with rationale for each finding\n2. **Display full plan table BEFORE asking** \u2014 never ask without showing\n3. Present Action question: Fix All / By Severity / Review Each / Report Only\n4. Present Severity filter: CRITICAL / HIGH / MEDIUM / LOW (multiselect)\n5. Severity question only applies when Action = \"By Severity\"\n\n## Needs-Approval Flow [STANDARD]\n\nAfter apply phase, if needs_approval > 0 and not --auto:\n\n1. Display needs-approval items table with ID, severity, issue, location, reason\n2. Ask: Fix All / Skip / Review Each\n3. \"Review Each\" iterates individually with Apply/Skip per item\n\n## Confidence Scoring [STANDARD]\n\nEach finding includes confidence (0-100):\n\n| Factor | Weight |\n|--------|--------|\n| Pattern Match | 40% |\n| Context Clarity | 30% |\n| Fix Determinism | 20% |\n| Test Coverage | 10% |\n\n| Score | Action |\n|-------|--------|\n| \u226590 | Auto-fix |\n| 80-89 | Auto-fix, visible in diff |\n| 70-79 | Show in plan, recommend |\n| 60-69 | Show in plan, ask approval |\n| <60 | Report only |\n\nThreshold: \u226580 for \"Apply Safe Only\". CRITICAL severity bypasses confidence.\n\n## Output Envelope [STANDARD]\n\nAll commands return same structure: `{ status, summary, data: { accounting, by_scope, by_severity }, error }`\n\nStatus: OK (failed=0), WARN (failed>0 no CRITICAL), FAIL (CRITICAL unfixed or error).\nAuto mode: print summary field only. Exit codes: 0 (OK), 1 (WARN), 2 (FAIL).\n\n## Skip Patterns [STANDARD]\n\nIntentionally marked code is never flagged:\n\n| Pattern | Reason |\n|---------|--------|\n| `# noqa`, `# intentional`, `# safe:` | Explicitly marked |\n| `_` prefixed variables | Convention for unused |\n| `TYPE_CHECKING` blocks | Type-only, not runtime |\n| Platform guards (`sys.platform`) | Intentional branching |\n| Test fixtures/data directories | Not production code |"}}
