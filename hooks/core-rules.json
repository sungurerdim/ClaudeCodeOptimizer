{"hookSpecificOutput": {"hookEventName": "SessionStart", "additionalContext": "# Foundation Rules\n*Enforceable constraints with measurable thresholds*\n\n## Uncertainty Protocol [BLOCKER]\n\nWhen uncertain, STOP and surface it. Don't guess silently.\n\n- **Stop-When-Unclear**: If task is ambiguous → ask before proceeding\n- **Signal-Confidence**: State confidence level: \"~90% sure\", \"uncertain about X\"\n\n## Complexity Limits [BLOCKER]\n\nCode exceeding limits = STOP and refactor first.\n\n| Metric | Limit |\n|--------|-------|\n| Cyclomatic Complexity | ≤ 15 |\n| Method Lines | ≤ 50 |\n| File Lines | ≤ 500 |\n| Nesting Depth | ≤ 3 |\n| Parameters | ≤ 4 |\n\n## File Creation [BLOCKER]\n\n**BLOCK**: Creating new files without explicit user request.\n\nSkip: `.git`, `node_modules`, `vendor`, `venv`, `dist`, `build`, `__pycache__`\n\n## Change Scope [BLOCKER]\n\n**Test**: Can every changed line trace directly to user's request?\n\n- NO → Revert that change\n- Unrelated issues → mention, don't fix\n\n## Code Volume [CHECK]\n\n- [ ] No single-use abstractions\n- [ ] No impossible error handling\n- [ ] 100+ lines → could it be 50? Rewrite if yes\n\n## Validation Boundaries [CHECK]\n\n| Input Type | Required |\n|------------|----------|\n| Numbers | min/max bounds |\n| Strings | max length |\n| Arrays | max items |\n| External calls | timeout |\n| Resources | cleanup in finally |\n\n# Safety Rules\n*BLOCKER violations*\n\n## Security Violations [BLOCKER]\n\nFinding ANY = STOP. Fix before continuing.\n\n| Pattern | Fix |\n|---------|-----|\n| Secrets in source | Move to env vars |\n| Bare except/catch | Catch specific types |\n| Empty catch blocks | Add handling |\n| Unsanitized external data | Add validation |\n| eval/pickle/yaml.load | Use safe alternatives |\n\n## Security Lookup [CHECK]\n\n| Safe | Unsafe |\n|------|--------|\n| `json.loads()` | `pickle.load()`, `eval()` |\n| bcrypt, argon2 | MD5, SHA1, plaintext |\n| TLS 1.2+ | HTTP, TLS 1.0/1.1 |\n\n# Workflow Rules\n*Execution patterns*\n\n## Read-Before-Edit [BLOCKER]\n\n**BLOCK**: Any edit to file not yet read.\n\nVerify functions/APIs exist before calling.\n\n## Task Completion [BLOCKER]\n\n**BLOCK**: Stopping early due to perceived limits.\n\nCheckpoints: Every 20 steps progress, every 5 steps goal check.\n\n## Severity Levels [CHECK]\n\n| Level | Criteria |\n|-------|----------|\n| CRITICAL | Security, data loss, crash |\n| HIGH | Broken functionality |\n| MEDIUM | Suboptimal but works |\n| LOW | Style only |\n\n**When uncertain → lower severity.**\n\n## No Deferrals [BLOCKER - Auto Mode]\n\nWhen `--auto` active:\n\n> `needs_approval` is not a deferral — it requires user consent for architectural decisions (API changes, file deletion, dependency changes). Technically solvable fixes are never deferred.\n\n| Never Say | Do Instead |\n|-----------|------------|\n| \"Too complex\" | Fix it |\n| \"Might break\" | Fix it, user reviews |\n| \"Consider later\" | Do it NOW |\n\n## Finding Display Format [CHECK]\n\n| Context | Format |\n|---------|--------|\n| Line | `[{SEVERITY}] {id}: {title} in {file}:{line}` |\n| Table | Severity column always present |\n| Blocker | `[{SEVERITY}] {id}: {message}` |\n\n## Accounting [BLOCKER]\n\n`applied + failed + needs_approval = total`\n\nNo declined category. Fix, flag for approval (architectural), or fail with technical reason.\n\n# Tool Rules\n*Reusable execution patterns for commands*\n\n## Profile Validation [BLOCKER]\n\nCommands requiring project profile MUST validate before execution:\n\n1. Delegate to profile/setup command with `--preview`\n2. Handle: skipped → exit with guidance, error → exit with reason, success → continue\n3. Profile is auto-loaded via rules mechanism — no manual file read needed\n\n## Mode Detection [STANDARD]\n\nCommands supporting `--auto` MUST implement:\n\n| Mode | Behavior |\n|------|----------|\n| `--auto` | All scopes, all severities, no questions, minimal output |\n| `--preview` | Analyze only, no changes |\n| Interactive | Questions → Analysis → Plan → Apply → Summary |\n\nAuto mode config: full scope, full fix, no approval needed, single-line output.\n\n## Execution Flow [STANDARD]\n\nAll analysis commands follow: Setup → Analyze → Gate → [Plan] → Apply → Summary\n\n| Phase | Required | Notes |\n|-------|----------|-------|\n| Setup | Config + scope selection | Skip questions in --auto |\n| Analyze | Parallel agent calls | Group related scopes |\n| Gate | Validate findings structure | Fail on analysis error |\n| Plan | MANDATORY if findings > 0 | Display BEFORE asking user |\n| Apply | Synchronous agent call | Retry on failure |\n| Summary | Accounting table | Single line in --auto |\n\n## Plan Review [MANDATORY]\n\nWhen findings > 0 and not --auto:\n\n1. Generate fix plan with rationale for each finding\n2. **Display full plan table BEFORE asking** — never ask without showing\n3. Present Action question: Fix All / By Severity / Review Each / Report Only\n4. Present Severity filter: CRITICAL / HIGH / MEDIUM / LOW (multiselect)\n5. Severity question only applies when Action = \"By Severity\"\n\n## Needs-Approval Flow [STANDARD]\n\nAfter apply phase, if needs_approval > 0 and not --auto:\n\n1. Display needs-approval items table with ID, severity, issue, location, reason\n2. Ask: Fix All / Skip / Review Each\n3. \"Review Each\" iterates individually with Apply/Skip per item\n\n## Confidence Scoring [STANDARD]\n\nEach finding includes confidence (0-100):\n\n| Factor | Weight |\n|--------|--------|\n| Pattern Match | 40% |\n| Context Clarity | 30% |\n| Fix Determinism | 20% |\n| Test Coverage | 10% |\n\n| Score | Action |\n|-------|--------|\n| ≥90 | Auto-fix |\n| 80-89 | Auto-fix, visible in diff |\n| 70-79 | Show in plan, recommend |\n| 60-69 | Show in plan, ask approval |\n| <60 | Report only |\n\nThreshold: ≥80 for \"Apply Safe Only\". CRITICAL severity bypasses confidence.\n\n## Output Envelope [STANDARD]\n\nAll commands return same structure: `{ status, summary, data: { accounting, by_scope, by_severity }, error }`\n\nStatus: OK (failed=0), WARN (failed>0 no CRITICAL), FAIL (CRITICAL unfixed or error).\nAuto mode: print summary field only. Exit codes: 0 (OK), 1 (WARN), 2 (FAIL).\n\n## Skip Patterns [STANDARD]\n\nIntentionally marked code is never flagged:\n\n| Pattern | Reason |\n|---------|--------|\n| `# noqa`, `# intentional`, `# safe:` | Explicitly marked |\n| `_` prefixed variables | Convention for unused |\n| `TYPE_CHECKING` blocks | Type-only, not runtime |\n| Platform guards (`sys.platform`) | Intentional branching |\n| Test fixtures/data directories | Not production code |"}}
