# Comment on PRs to main with version info based on labels

name: PR Version Check

on:
  pull_request:
    types: [opened, labeled, unlabeled, synchronize]
    branches: [main]

permissions:
  pull-requests: write

jobs:
  version-check:
    name: Check Version Label
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check label and comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABELS='${{ toJSON(github.event.pull_request.labels.*.name) }}'
          PR_NUMBER=${{ github.event.pull_request.number }}

          CURRENT=$(python3 -c "import json; print(json.load(open('.claude-plugin/plugin.json'))['version'])")
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          PATCH_V="${MAJOR}.${MINOR}.$((PATCH + 1))"
          MINOR_V="${MAJOR}.$((MINOR + 1)).0"
          MAJOR_V="$((MAJOR + 1)).0.0"

          HAS_LABEL=false
          SELECTED=""

          if echo "$LABELS" | grep -q '"version:major"'; then
            HAS_LABEL=true; SELECTED="**major** â†’ v${MAJOR_V}"
          elif echo "$LABELS" | grep -q '"version:minor"'; then
            HAS_LABEL=true; SELECTED="**minor** â†’ v${MINOR_V}"
          elif echo "$LABELS" | grep -q '"version:patch"'; then
            HAS_LABEL=true; SELECTED="**patch** â†’ v${PATCH_V}"
          fi

          if [ "$HAS_LABEL" = true ]; then
            BODY="ðŸ“¦ **Version bump:** ${SELECTED}

          Current: v${CURRENT}

          | Label | Version |
          |-------|---------|
          | \`version:patch\` | v${PATCH_V} |
          | \`version:minor\` | v${MINOR_V} |
          | \`version:major\` | v${MAJOR_V} |"
          else
            BODY="âš ï¸ **No version label found!**

          Please add one of: \`version:patch\`, \`version:minor\`, or \`version:major\`

          Current version: v${CURRENT}

          | Label | Version |
          |-------|---------|
          | \`version:patch\` | v${PATCH_V} |
          | \`version:minor\` | v${MINOR_V} |
          | \`version:major\` | v${MAJOR_V} |"
          fi

          # Delete previous bot comments on this PR
          gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.user.login == "github-actions[bot]") | .id' | \
            while read -r id; do
              gh api -X DELETE "repos/${{ github.repository }}/issues/comments/${id}"
            done

          gh pr comment "$PR_NUMBER" --body "$BODY"
