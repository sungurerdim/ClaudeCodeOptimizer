# Release workflow for Claude Code Plugin

name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate version matches tag
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          PKG_VERSION=$(python3 -c "import json; print(json.load(open('.claude-plugin/plugin.json'))['version'])")
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "Error: Tag version ($TAG_VERSION) does not match plugin.json version ($PKG_VERSION)"
            exit 1
          fi
          echo "âœ“ Version validated: $PKG_VERSION"

      - name: Generate release summary
        run: |
          echo "## Claude Code Optimizer v${GITHUB_REF#refs/tags/v}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "/plugin install github:sungurerdim/ClaudeCodeOptimizer" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Contents" >> $GITHUB_STEP_SUMMARY
          echo "- **Commands:** $(ls -1 commands/*.md | wc -l) slash commands" >> $GITHUB_STEP_SUMMARY
          echo "- **Agents:** $(ls -1 agents/*.md | wc -l) subagents" >> $GITHUB_STEP_SUMMARY
          echo "- **Rules:** $(find rules -name 'cco-*.md' -type f | wc -l) rule files" >> $GITHUB_STEP_SUMMARY
