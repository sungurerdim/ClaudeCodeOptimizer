# Automated release on PR merge to main
# Requires PR label: version:patch, version:minor, or version:major

name: Release

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    name: Version Bump & Release
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version bump
        id: bump
        run: |
          LABELS='${{ toJSON(github.event.pull_request.labels.*.name) }}'

          PATCH=$(echo "$LABELS" | grep -c '"version:patch"' || true)
          MINOR=$(echo "$LABELS" | grep -c '"version:minor"' || true)
          MAJOR=$(echo "$LABELS" | grep -c '"version:major"' || true)

          if [ "$MAJOR" -gt 0 ]; then
            echo "type=major" >> "$GITHUB_OUTPUT"
          elif [ "$MINOR" -gt 0 ]; then
            echo "type=minor" >> "$GITHUB_OUTPUT"
          elif [ "$PATCH" -gt 0 ]; then
            echo "type=patch" >> "$GITHUB_OUTPUT"
          else
            echo "::error::No version label found. Add version:patch, version:minor, or version:major to the PR."
            exit 1
          fi

      - name: Calculate new version
        id: version
        run: |
          CURRENT=$(python3 -c "import json; print(json.load(open('.claude-plugin/plugin.json'))['version'])")
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "${{ steps.bump.outputs.type }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW="${MAJOR}.${MINOR}.${PATCH}"
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "new=$NEW" >> "$GITHUB_OUTPUT"
          echo "Bump: $CURRENT â†’ $NEW (${{ steps.bump.outputs.type }})"

      - name: Update plugin.json version
        run: |
          python3 -c "
          import json, pathlib
          p = pathlib.Path('.claude-plugin/plugin.json')
          data = json.loads(p.read_text())
          data['version'] = '${{ steps.version.outputs.new }}'
          p.write_text(json.dumps(data, indent=2) + '\n')
          "

      - name: Commit and tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .claude-plugin/plugin.json
          git commit -m "release: v${{ steps.version.outputs.new }}"
          git tag "v${{ steps.version.outputs.new }}"
          git push origin main --follow-tags

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.version.outputs.new }}" \
            --title "v${{ steps.version.outputs.new }}" \
            --generate-notes
